(()=>{"use strict";const t=class{_array;_count;constructor(){this._array=[],this._count=0}get length(){return this._count}get capacity(){return this._array.length}clear(){this._array.fill(void 0),this._count=0}contains(t){for(let e=0;e<this._array.length;e++)if(this._array[e]==t)return!0;return!1}peek(){return this._array[this._count-1]}push(t){if(this._array.length==this._count)return this._array.push(t),void this._count++;this._array[this._count]=t,this._count++}pop(){if(0==this._count)throw new Error("Failed to pop from stack. Stack is empty.");this._count--;const t=this._array[this._count];return this._array[this._count]=void 0,t}shift(){if(0==this._count)throw new Error("Failed to shift from stack. Stack is empty.");this._count--;const t=this._array[0];for(let t=0;t<this._count;t++)this._array[t]=this._array[t+1];return this._array[this._count]=void 0,t}};class e{x;y;width;height;constructor(t=0,e=0,s=0,i=0){this.x=t,this.y=e,this.width=s,this.height=i}set(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}set4f(t,e,s,i){return this.x=t,this.y=e,this.width=s,this.height=i,this}offset(t,e){return this.x+=t,this.y+=e,this}copy(){return new e(this.x,this.y,this.width,this.height)}isEmpty(){return this.width<=0||this.height<=0}expand(t){return this.x-=t,this.y-=t,this.width+=2*t,this.height+=2*t,this}scale(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this}floor(){const t=this.x+this.width|0,e=this.y+this.height|0;return this.x=0|this.x,this.y=0|this.y,this.width=t-this.x,this.height=e-this.y,this}normalize(){return this.width<0&&(this.x+=this.width,this.width=-this.width),this.height<0&&(this.y+=this.height,this.height=-this.height),this}union(t){return this.union4f(t.x,t.y,t.width,t.height)}union4f(t,e,s,i){if(0==s||0==i)return this;if(this.isEmpty())return this.set4f(t,e,s,i);const n=Math.max(this.x+this.width,t+s),r=Math.max(this.y+this.height,e+i);return this.x=Math.min(this.x,t),this.y=Math.min(this.y,e),this.width=n-this.x,this.height=r-this.y,this}intersection(t){return this.intersection4f(t.x,t.y,t.width,t.height)}intersection4f(t,e,s,i){if(this.x+this.width<=t||this.y+this.height<=e||t+s<=this.x||e+i<=this.y)return this.set4f(0,0,0,0),this;const n=Math.max(this.x,t),r=Math.max(this.y,e),o=Math.min(this.x+this.width,t+s),a=Math.min(this.y+this.height,e+i);return this.set4f(n,r,o-n,a-r),this}isPointIn2f(t,e){return this.x<=t&&this.y<=e&&t<this.x+this.width&&e<this.y+this.height}contains(t){return this.x<=t.x&&this.y<=t.y&&t.x+t.width<=this.x+this.width&&t.y+t.height<=this.y+this.height}toString(){return`{x: ${this.x}, y: ${this.y}, width: ${this.width}, height: ${this.height}}`}static union(t,s){return new e(t.x,t.y,t.width,t.height).union(s)}static intersection(t,s){return new e(t.x,t.y,t.width,t.height).intersection(s)}static intersection8f(t,s,i,n,r,o,a,h){return new e(t,s,i,n).intersection4f(r,o,a,h)}}const s=e;function i(t,e,s){return t<e?e:t>s?s:t}const n="undefined"!=typeof chrome&&void 0!==chrome.runtime;function r(t,e,i,n,r){const a=new Uint8ClampedArray(i.length),h=[];let l=n,c=n,u=r,d=r;for(h.push(n,r);h.length>0;){const s=h.pop(),n=h.pop(),r=4*(s*t+n)+3;if(0!=a[r])continue;let g,A;for(g=n-1,A=r-4;g>=0&&0!=i[A];g--,A-=4);const p=g+1,m=A+4;for(g=n+1,A=r+4;g<t&&0!=i[A];g++,A+=4);const v=g-1,f=A-4;for(A=m;A<=f;A+=4)a[A]=i[A];p<l&&(l=p),v>c&&(c=v),s-1>=0&&(s-1<u&&(u=s-1),o(t,i,h,p,v,s-1)),s+1<e&&(s+1>d&&(d=s+1),o(t,i,h,p,v,s+1))}return{region:a,rect:new s(l,u,c-l+1,d-u+1)}}function o(t,e,s,i,n,r){let o=i,a=4*(r*t+o)+3;for(;o<=n;){for(;o<=n;o++,a+=4)if(0!=e[a]){s.push(o,r);break}for(;o<=n&&0!=e[a];o++,a+=4);}}class a{r;g;b;a;constructor(t=0,e=0,s=0,i=1){this.r=0|t,this.g=0|e,this.b=0|s,this.a=i}copy(){return new a(this.r,this.g,this.b,this.a)}set(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a}setHsv(t,e,s){const i=255*s,n=s*(1-e)*255;let r,o,a;return t<=60?(r=i,o=t/60*(i-n)+n,a=n):t<=120?(r=(120-t)/60*(i-n)+n,o=i,a=n):t<=180?(r=n,o=i,a=(t-120)/60*(i-n)+n):t<=240?(r=n,o=(240-t)/60*(i-n)+n,a=i):t<=300?(r=(t-240)/60*(i-n)+n,o=n,a=i):(r=i,o=n,a=(360-t)/60*(i-n)+n),this.r=Math.round(r),this.g=Math.round(o),this.b=Math.round(a),this}set3i(t,e,s){return this.r=0|t,this.g=0|e,this.b=0|s,this}set4f(t,e,s,i){return this.r=0|t,this.g=0|e,this.b=0|s,this.a=i,this}equals(t){return this.r==t.r&&this.g==t.g&&this.b==t.b&&this.a==t.a}css(){return 1==this.a?`rgb(${this.r},${this.g},${this.b})`:`rgba(${this.r},${this.g},${this.b},${this.a})`}code(){return`#${(i(this.r,0,255)<<16|i(this.r,0,255)<<8|i(this.r,0,255)).toString(16)}`}hsv(){const t=this.r,e=this.g,s=this.b,i=Math.max(t,e,s),n=Math.min(t,e,s);let r;return r=i==n?0:t==i?60*(e-s)/(i-n):e==i?60*(s-t)/(i-n)+120:60*(t-e)/(i-n)+240,r<0&&(r+=360),{h:r,s:0==i?0:(i-n)/i,v:i/255}}value(){return Math.max(this.r,this.g,this.b)/255}serialize(){return{r:this.r,g:this.g,b:this.b,a:this.a}}static fromHsv(t,e,s){const i=new a;return i.setHsv(t,e,s),i}static deserialize(t){const e=t,s=e.r,i=e.g,n=e.b,r=t.a;return new a(s,i,n,r)}}!function(t){t.structure={r:"number",g:"number",b:"number",a:"number"},t.black=new t(0,0,0),t.white=new t(255,255,255),t.transparent=new t(0,0,0,0)}(a||(a={}));const h=a;class l{#t=new Map;addObserver(t,e,s){let i=this.#t.get(e);void 0===i&&(i=[],this.#t.set(e,i)),i.push({observer:t,callback:s})}removeObserver(t,e,s){return void 0===e?this.#e(t):void 0===s?this.#s(t,e):this.#i(t,e,s)}#e(t){let e=!1;for(let s of this.#t.keys())e=this.#s(t,s)||e;return e}#s(t,e){const s=this.#t.get(e);if(!s)return!1;let i=!1;for(let e=0;e<s.length;e++)s[e].observer==t&&(i=!0,s.splice(e,1),e--);return i}#i(t,e,s){const i=this.#t.get(e);if(!i)return!1;for(let e=0;e<i.length;e++){const n=i[e];if(n.observer==t&&n.callback!=s)return i.splice(e,1),!0}return!1}notify(t,e){const s=this.#t.get(t);if(s)for(let t of s)t.callback.call(t.observer,e)}}const c={"button-close.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAWklEQVRIie3TMQpAIQwD0PTk6snj8qeCEtTAH5rRQh5oDZJwJgoowAuMiAYAjRwncxXoAHou2c1kYFWklktALvyOpHIZSAjU8v8A1iuyPrJ9Te0f7UUKKOA+E+t8ldGAbQrmAAAAAElFTkSuQmCC","cursor-bucket.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAASCAYAAAC5DOVpAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAj0lEQVQ4ja3T2w3AIAgF0MtSbuDUbuBSt1801vJQW76MgZOgICSRhCZIligJxloKAKD1noIRxlqKIhjOLuhhNIqtuxSLikJwxDi144YHKnY/9E7MoJA8gizwMzaCv2AKPrDWO05hEwOwDY5tAu/5WW59/gC9J55zk4LWaET5LhgN7Ra4sk5L4O6iu6DWeAkX86yQ25BXTdMAAAAASUVORK5CYII=","cursor-prohibit.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAArElEQVQ4jZ3TIRbCMAwG4D8OXc0cew/JqXaDySkkN9ipkLxXWc00LghgS9Mtzahs939d05SYGXpMTVtOAggpkp4jCWwFLWgGZDgMPdB1eWocP99dbxlCzFwPK0giGfC6nHG4P9xISJHoeTxxtvNv0ULEXyxAiuUOBjI1rQE4kDpQQXyAgZSAo2i60IDoA/fVDf12H+xpogz4nmlBgNVW1uH5CKIw/z8mOfY85zeDDKr78oKJsQAAAABJRU5ErkJggg==","cursor-select.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAR0lEQVQokdWSMQ7AIAwDff9/9HWgUllqBsSAV+cSxTJqikzCn0mDAdXb4JWOwsu0hc+ffhTIu5xkZDDN7V9ucNU5+N6G1bQfQoFU4lFCPW0AAAAASUVORK5CYII=","cursor-spoit.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAbElEQVQ4jZ3QQRLAIAhD0XD/Q6cbaUFFQ9np+P6oRhLNScCaAZrZtyClwHsgYjXAGXUDZWQ4k27gZzzkGDh/YsLdwBaTRNgvAyUeiI53gRteJgba+BhQcAwwfhIACS+BACXsgfntEkyBP9DnAR/3hd2UXxaoAAAAAElFTkSuQmCC","icon-layer-delete.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAACZJREFUeNpjwAB1QNzIwMD+/wEDE4MDA5MnQQxWx8jQwMDwH8M0AOKFCc1N4IYiAAAAAElFTkSuQmCC","icon-layer-down.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADNJREFUeNpjwAokgNgGgdlsEhj4bT4w8O/9wMD+/wED8/8DDIz/GxgY/gPl66DqJLCaBAACdQtfNgILfQAAAABJRU5ErkJggg==","icon-layer-new.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAACVBMVEVHcEyWkJAuIiLxE1ZXAAAAAXRSTlMAQObYZgAAAFZJREFUeNq1ksEKwDAMQpP3/x+9y2QkIjuUeipaNYHUHUCkIf4Gp/0NwV0GkuOvo3tO1f3yaw9ASo8QaoQJQAGiv1y51CF5OSSFDoUhwV3CHsGlowN4ALa/AKJI7ye1AAAAAElFTkSuQmCC","icon-layer-up.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADRJREFUeNpjwAokgNgGiOuA+D8DA+P/Bgbm/wcY2P8/YODf+4GB3+YDA5tNAkgNAktgNQkAOWULX39+ExMAAAAASUVORK5CYII=","icon-resize.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAe0lEQVRIie3U0RGAIAgG4JiFAdh/DAZgFnrCo/I8KPEl/6f0jM/wElT1qAwsAQjxk8IiYM+EqH48FfB1bG4a0KvBItAAFnlVnBBjLdrABn4ALPnRSq8KBz5bVJkLcNdHia5tgLUpA0TWTz+DLpDZkSX1Bf6lsjOoSjlwAtEn+dHqkNssAAAAAElFTkSuQmCC","icon-settings.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAuklEQVRIieWVPQ6DMAyFXy7lmQ45F3CuDHT2pdKFVsa1U1eQSFU9QfLizz/gpForelr6H0AmmgEs++tSmNdTgEw0SyeZqBbmpJ8t7UeAjLYwp0xUAdwL823f3wBMYs/N6g3wdC6jtQ5HdV4GhxJEzDvT6kEY0tK6GUCl2/qKdLlcgHDyaqjlwAlgAzDpdQ0wU7XWo9rhgL4lklEYDs43OVKCb7Xjf7RRo6LfsJOQbuPaA+LKC+cq+33AA08KO+DwokjEAAAAAElFTkSuQmCC","layer-visible.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAPElEQVR42mNwL/BhoCVmGLVg1ALaWKCnpPSfHDzgFpBlGcVx8B8CaGcB1KBRC4anBYQtGS3sRi0YJhYAAEFAcqGi8cq+AAAAAElFTkSuQmCC","resize.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAPUlEQVQ4jWP8//8/AzUAIykGuZqZwRXvPnWKcRgZhA/Q3iBs3iDLa4PPIFIBdQ0i1hsEvTb4DKIGGMYGAQDsk33dryVidQAAAABJRU5ErkJggg==","separator.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAYCAYAAAAlBadpAAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAKklEQVQ4jWP8//8/A7mAcVQzFTWvW77gf1BkAuOo5lHNw00zITCqmUQAAH2Sd9FJIRj3AAAAAElFTkSuQmCC","tool-bucket.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAh0lEQVRIie3UwQ3AIAgFUFiKDZzaDVgKTyamRUGkB5Ny0oT8d0BBEYEvC3/gLqAQCQBAZcZ0oBBJDx7PKYAW6EVMYBXkQZaAJ8DqUYE+zJ2aIS8gEr5CUgENSQeeyBSozBjF3MB4j4SrQA8dG72Ia8izshD3M40g2x9tBzlaFRaSsuxO636gAT67o9FFZhjUAAAAAElFTkSuQmCC","tool-clear.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAAC9JREFUeNpjQAEcDAwsHAIMTBwKDIwMDgwMDQ0M6EAGCJEASA1ILUgPWC8DB4osAJ4+A1fAtKbkAAAAAElFTkSuQmCC","tool-eraser.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADpJREFUeNoFwUERgDAMALBs7LjC8RgOKqXSKhUpJAAAnLiwmywq6W0IUzhsq1NUiWzxsm7mw9j4AMAP2rMFECPg2wMAAAAASUVORK5CYII=","tool-fill.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAACVJREFUeNpjQAbM/x+gYH4g5kbCHEA1/D+ABIhhB8RKOLAd3EgAU5kRlFZpM08AAAAASUVORK5CYII=","tool-flip.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAgMAAACdGdVrAAAACVBMVEVHcEz///8uIiKmzw8MAAAAAXRSTlMAQObYZgAAAD9JREFUeNpjwAGYkCgmEARSDUwMXEAqgYlBC0hFMDGsAlJhTEwgKrSJC0wlaUEpqCBMCVQDVDvCMBBEtg+XewAh1AyZ2jzydgAAAABJRU5ErkJggg==","tool-layer.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADRJREFUCNdjYEAGEkCcxsDA2NjAwMaQAORKMCgwsIBpEF+ycQaDQhqQL4GdD9IH0g82BwIAkScJJTEAnacAAAAASUVORK5CYII=","tool-new.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAARklEQVR42mNwL/BhoCVmGJ4W6Ckp/ScFk2UBMQCoDk7T0AIEm4YWIPjUtgAZU2gBYTBqwagFoxaMWkB1C8jEmBaMVvqEMAAXva/vvef6fwAAAABJRU5ErkJggg==","tool-pen.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADhJREFUeNrN0TESACAMAkH2/5+2tDCUjjKpLjRAHojCE5WrfpVrfp9wI49954M5ciJK13IIuLbxAkU4AEGidvNhAAAAAElFTkSuQmCC","tool-redo.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADRJREFUeNpjoCFgxCnBiFOCEacEIxIPDcDF8UggNKNycFiOxsYhgeEpyn2L6RGcMgyDGAAAeCQAX7lYuxcAAAAASUVORK5CYII=","tool-save.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAW0lEQVR42mNwL/BhoCVmGF4W6Ckp/ScHk2QBMkDio4tj0LS0AM6mzAKEGFwcm3pKLSDKAaRYgA+TZwGJYARbQGpmI88CIsFgtoBwUI36YChGMoUY04LRSp8QBgD5ZKlyz+ZM9QAAAABJRU5ErkJggg==","tool-select.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsSAAALEgHS3X78AAAAG3RFWHRTb2Z0d2FyZQBDZWxzeXMgU3R1ZGlvIFRvb2zBp+F8AAAAUklEQVRIiWP8//8/Ay0B46gFJFvgamb2n4GBgWH3qVOMMDY6n5AcQQvQFRELsOkdmCCiqQ+GvgXUBqNBRBAMwyAajQOigoiBgYbFNbXBqAUEAQBHHL/RApKjtgAAAABJRU5ErkJggg==","tool-size.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAAB1JREFUeNpjwAnqGBgY/zeAMfP/A9gwTB6oFqcpAEOjEYm5OdyJAAAAAElFTkSuQmCC","tool-spoit.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADBJREFUeNrV0aENADAAw7Dk/6f3QIMGphVaKgp/TC13636kQzkajuFcO6Y7vRjfBDs0zgAraRL/UwAAAABJRU5ErkJggg==","tool-undo.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAADJJREFUeNpjQAaMQMwMxOxAzA/E8v8PAPEDIPsBUCyBgRmIGYGYAYaB4sz/gRioDgcAAArGC1XYAMt9AAAAAElFTkSuQmCC","tool-zoom-in.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAAEFJREFUCNdjYAACxj8MDGzMDAwcDA0MAgwODAoKCmDsoCAAx+7/BVD4MDUg9RwMD4D6C4DmWABNkwFiPiBmAxkNAAlvCmtBQJnaAAAAAElFTkSuQmCC","tool-zoom-out.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAAADaua+7AAAABlBMVEVHcEwuIiLfK+h/AAAAAXRSTlMAQObYZgAAAD5JREFUCNdjYAACxj8MDGzMDAwcDA0MAgwODApQ6ADmQbD7fwEUPkwNiMfB8ACovwBojgXQNBkg5gNiNpDRAMXgCSuLnmo3AAAAAElFTkSuQmCC","transparent-m.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAAAAAA6mKC9AAAAAXNSR0IArs4c6QAAABhJREFUeNpj+A8FZ6CAYYAEYAyYxAAJAAD0J+WB8+cu5gAAAABJRU5ErkJggg==","transparent.png":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAAAAADhZOFXAAAAFklEQVR42mM4AwT/gYABDwNEgDh4GAASQDlhZyXAgAAAAABJRU5ErkJggg=="};function u(t){return c[t]||""}function d(t,e,s){const i=document.createElement("template");i.innerHTML=t;const n=i.content.firstElementChild;if(!(n instanceof HTMLElement))throw new Error("First element must be HTML element");return g(n,e,s),n}function g(t,e,s){for(let i of t.attributes){if(void 0!==s&&"name"==i.name)s[i.value]=t;else if(void 0!==e&&i.name.startsWith("data-on-")){const s=i.name.substring(8),n=i.value;if("function"!=typeof e[n])throw new Error(`[Discord Tegaki]Controller doesn't have ${n} method`);t.addEventListener(s,(function(t){return e[n](t)})),"click"==s&&t.addEventListener("pointerdown",(function(t){t.preventDefault(),t.stopPropagation()}))}if("src"==i.name&&i.value.match(/^\[.+\]$/)){const t=i.value.substring(1,i.value.length-1);i.value=u(t)}}let i;i=t instanceof HTMLTemplateElement?t.content.children:t.children;for(let t of i)t instanceof HTMLElement&&g(t,e,s);return t}function A(t){const e=t.getBoundingClientRect();e.x<0?t.style.left="0":e.right>document.documentElement.clientWidth&&(t.style.left=document.documentElement.clientWidth-t.clientWidth+"px"),e.y<0?t.style.top="0":e.bottom>document.documentElement.clientHeight&&(t.style.top=document.documentElement.clientHeight-t.clientHeight+"px")}class p{canvas;context;constructor(t=100,e=100){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e;const s=this.canvas.getContext("2d");if(null==s)throw new Error("Failed to get OffscreenCanvasRenderingContext2D");this.context=s}copy(){const t=new p(this.width,this.height);return t.context.drawImage(this.canvas,0,0),t}set(t){return this.canvas.width==t.width&&this.canvas.height==t.height?this.clear():(this.canvas.width=t.width,this.canvas.height=t.height),this.context.drawImage(t.canvas,0,0),this}get width(){return this.canvas.width}set width(t){this.canvas.width=t}get height(){return this.canvas.height}set height(t){this.canvas.height=t}setSize(t,e){return this.canvas.width=t,this.canvas.height=e,this}clear(){this.context.clearRect(0,0,this.width,this.height)}fill(t){this.context.fillStyle=t.css(),this.context.fillRect(0,0,this.width,this.height)}}const m=p;class v{_pool;_type;constructor(e){this._type=e,this._pool=new t}get(){try{return this._pool.pop()}catch{return new this._type}}return(t){this._pool.push(t)}}const f=new Map;!function(t){t.sharedPoolFor=function(e){let s=f.get(e);return void 0===s&&(s=new t(e),f.set(e,s)),s}}(v||(v={}));const _=v;class w{size;color;composite;constructor(t,e,s){this.size=t,this.color=e.copy(),this.composite=s}eqauls(t){return this.size==t.size&&this.color.equals(t.color)&&this.composite==t.composite}}const b=_.sharedPoolFor(m);class y{canvas;constructor(t){this.canvas=t}dispose(){}}function C(t,e,s,i=1){if(0==s.length)return;t.save(),t.lineCap="round",t.lineJoin="round",t.strokeStyle=e.color.css(),t.globalCompositeOperation=e.composite,t.lineWidth=e.size,t.beginPath();const n=s[0];if(t.moveTo(n.x,n.y),1==s.length)t.lineTo(n.x,n.y);else for(let e=1;e<s.length;e++){const i=s[e];t.lineTo(i.x,i.y)}t.stroke(),t.restore()}!function(t){t.None=class extends t{exec(){}},t.Merge=class extends t{#n;constructor(t,...e){super(t.canvas),this.#n=[t].concat(e)}exec(){for(const t of this.#n)t.exec()}add(t){this.#n.push(t)}unshift(t){this.#n.unshift(t)}get first(){return this.#n[0]}get last(){return this.#n[this.#n.length-1]}dispose(){for(const t of this.#n)t.dispose()}},t.ChangeDocument=class extends t{#r;constructor(t,e){super(t),this.#r=e}exec(){this.canvas.document=this.#r}},t.ChangeBackgroundColor=class extends t{#o;constructor(t,e){super(t),this.#o=e.copy()}exec(){this.canvas.backgroundColor=this.#o}get color(){return this.#o}},t.AddLayer=class extends t{#a;#h;constructor(t,e,s){super(t),this.#a=e,this.#h=s}exec(){this.canvas.layers.splice(this.#a,0,this.#h),this.canvas.notify("add-layer",{layer:this.#h,position:this.#a}),this.canvas.selectLayerAt(this.#a)}},t.DeleteLayer=class extends t{#a;constructor(t,e){super(t),this.#a=e}exec(){const t=this.canvas.layers.splice(this.#a,1)[0];this.canvas.notify("delete-layer",{layer:t,position:this.#a}),this.canvas.selectLayerAt(Math.max(0,this.#a-1))}},t.MoveLayer=class extends t{#a;#l;constructor(t,e,s){super(t),this.#a=e,this.#l=s}exec(){const t=this.canvas.layers.splice(this.#a,1)[0];this.canvas.layers.splice(this.#l,0,t),this.canvas.notify("move-layer",{layer:t,from:this.#a,to:this.#l}),this.canvas.selectLayer(t)}},t.ChangeLayerOpacity=class extends t{layer;opacity;constructor(t,e,s){super(t),this.layer=e,this.opacity=s}exec(){this.layer.opacity=this.opacity}},t.SelectNew=class extends t{#c;constructor(t,e){super(t),this.#c=e}exec(){this.canvas.selectedRegion=this.#c}},t.GrabState=class{layer;backupImage;image;startX;startY;offsetX=0;offsetY=0;constructor(t,e){if(null==t.selectedRegion)throw new Error("Canvas has not selection");this.layer=e,this.backupImage=b.get().set(e),this.image=b.get(),t.putSelectedImageInto(this.image,e);const s=t.selectedRegion.boudingRect();this.startX=s.x,this.startY=s.y}dispose(){b.return(this.backupImage),b.return(this.image)}},t.SelectGrabStart=class extends t{#u;constructor(t,e){super(t),this.#u=e}exec(){this.canvas.grabState=this.#u}dispose(){this.#u.dispose()}},t.SelectGrabCancel=class extends t{#u;constructor(t,e){super(t),this.#u=e}exec(){console.log("SelectGrabCancel exec"),this.canvas.grabState=null;const t=this.#u.layer;t.set(this.#u.backupImage);const e=this.canvas.selectedRegion;null!=e&&(e.offsetX=0,e.offsetY=0),t.notify("update",t)}},t.SelectMove=class extends t{#d;#g;constructor(t,e,s){super(t),this.#d=e,this.#g=s}get x(){return this.#d}get y(){return this.#g}exec(){const t=this.canvas.selectedRegion;null!=t&&t.offset(this.#d,this.#g)}},t.SelectMoveImage=class extends t{#A;#p;#h;constructor(t,e,s,i){super(t),this.#h=e,this.#A=s,this.#p=i}exec(){const t=this.canvas.selectedRegion;if(null==t)return;const e=b.get(),s=this.canvas.putSelectedImageInto(e,this.#h);if(void 0===s)return void b.return(e);const i=this.#h;i.context.clearRect(s.x,s.y,s.width,s.height),i.context.drawImage(e.canvas,s.x+this.#A,s.y+this.#p),b.return(e),t.offset(this.#A,this.#p),i.notify("update",i)}},t.DrawImage=class extends t{_layer;_image;_rect;_copy;constructor(t,s,i,n,r,o,a,h,l,c=!0){super(t),this._layer=s,this._image=b.get(),this._image.width=o,this._image.height=a,this._image.context.drawImage(i.canvas,n,r,o,a,0,0,o,a),this._rect=new e(h,l,o,a),this._copy=c}get rect(){return this._rect}exec(){const t=this._layer.context;this._copy&&t.clearRect(this._rect.x,this._rect.y,this._rect.width,this._rect.height),t.drawImage(this._image.canvas,this._rect.x,this._rect.y),this._layer.notify("update",this._layer)}dispose(){b.return(this._image)}},t.Resize=class extends t{_width;_height;constructor(t,e,s){super(t),this._width=e,this._height=s}exec(){const t=b.get();for(let e of this.canvas.layers)t.set(e),e.width=this._width*this.canvas.innerScale,e.height=this._height*this.canvas.innerScale,e.clear(),e.context.drawImage(t.canvas,0,0),e.notify("update",e);b.return(t),this.canvas.setDocumentSize(this._width,this._height)}},t.DrawPath=class extends t{_layer;_brush;_pathList;constructor(t,e,s,i){super(t),this._layer=e,this._brush=s,this._pathList=[Array.from(i)]}get pathList(){return this._pathList}addPath(t){this._pathList.push(Array.from(t))}addPathList(t){this._pathList.push(...t)}get startTime(){return this._pathList[0][0].time}get finishTime(){const t=this._pathList[this._pathList.length-1];return t[t.length-1].time}get layer(){return this._layer}get brush(){return this._brush}exec(){const t=this._layer.context;this.canvas.clipBegin(t);for(const e of this._pathList)C(t,this._brush,e,this.canvas.innerScale);this.canvas.clipEnd(t),this._layer.notify("update",this._layer)}},t.UndoResize=class extends t{_layerImages;_width;_height;constructor(t){super(t),this._layerImages=[];for(const e of t.layers)this._layerImages.push(b.get().set(e));this._width=t.documentWidth,this._height=t.documentHeight}exec(){for(let t=0;t<this.canvas.layers.length;t++){const e=this.canvas.layers[t];e.set(this._layerImages[t]),e.notify("update",e)}this.canvas.setDocumentSize(this._width,this._height)}dispose(){for(let t of this._layerImages)b.return(t)}},t.Flip=class extends t{exec(){const t=b.get();for(const e of this.canvas.layers)t.set(e),e.clear(),e.context.save(),e.context.scale(-1,1),e.context.drawImage(t.canvas,-e.width,0),e.context.restore(),e.notify("update",e);b.return(t)}},t.Fill=class extends t{_layer;_color;constructor(t,e,s){super(t),this._layer=e,this._color=s.copy()}exec(){const t=this._layer,e=t.context;this.canvas.clipBegin(e),e.fillStyle=this._color.css(),e.fillRect(0,0,t.width,t.height),this.canvas.clipBegin(e),t.notify("update",t)}},t.Clear=class extends t{_layer;constructor(t,e){super(t),this._layer=e}exec(){this.canvas.clipBegin(this._layer.context),this._layer.clear(),this.canvas.clipEnd(this._layer.context),this._layer.notify("update",this._layer)}}}(y||(y={}));const x=y,k=class{_idx=0;_length=0;_array;capacity;constructor(t){this.capacity=t,this._array=new Array(t)}push(t){this._array[this._idx]=t,this._idx=(this._idx+1)%this.capacity,this._length<this.capacity&&this._length++}pop(){if(0==this._length)throw new Error("Failed to pop from stack. Stack is empty.");this._idx=-1,this._idx<0&&(this._idx+=this.capacity),this._length--;const t=this._array[this._idx];return this._array[this._idx]=void 0,t}peek(t=0){if(t>=this._length)return;let e=(this._idx-1-t)%this.capacity;return e<0&&(e+=this.capacity),this._array[e]}fill(t){this._array.fill(t),this._length=this.capacity}},S=class extends l{_updateTimer=0;_updateCallback=this.update.bind(this);_px=0;_py=0;_sx=0;_sy=0;_samplesNum=3;_weights;_samples;_path=[];constructor(){super(),this._samples=new k(this._samplesNum),this._weights=new Array(this._samplesNum);let t=100;for(let e=0;e<this._samplesNum;e++)this._weights[e]=t,t*=.85}get path(){return this._path}get isActive(){return 0!=this._updateTimer}start(t,e){this._px=t,this._py=e,this._sx=t,this._sy=e,this._samples.fill({x:t,y:e}),this._path=[{x:t,y:e,time:Date.now()}],this._updateTimer=window.setInterval(this._updateCallback,1e3/60)}update(){if(this._sx==this._px&&this._sy==this._py)return;this._samples.push({x:this._px,y:this._py});let t=0,e=0,s=0;for(let i=0;i<this._weights.length;i++){const n=this._weights[i];t+=n;const r=this._samples.peek(i);e+=n*(r.x-this._sx),s+=n*(r.y-this._sy)}e/=t,s/=t,this._sx+=e,this._sy+=s,this._path.push({x:this._sx,y:this._sy,time:Date.now()}),this.notify("update",this)}move(t,e){this._px=t,this._py=e}finish(){this._sx!=this._px||this._sy!=this._py?this._path.push({x:this._px,y:this._py,time:Date.now()}):this._path[this._path.length-1].time=Date.now(),window.clearInterval(this._updateTimer),this._updateTimer=0}};class E extends l{_value;constructor(t){super(),this._value=t}get value(){return this._value}set value(t){this._value!=t&&(this._value=t,this.notify("change",this._value))}sync(){this.notify("change",this._value)}}class R extends l{_value;constructor(t,e,s){super(),this._value=new h(t,e,s)}get value(){return this._value}set value(t){this.set(t)}get color(){return this._value}set(t){return this._value.equals(t)||(this._value.set(t),this.notify("change",this._value)),this}sync(){this.notify("change",this._value)}}class B extends m{#m=new l;#r=null;observables={opacity:new E(1),isVisible:new E(!0)};constructor(t,e){super(t,e)}get opacity(){return this.observables.opacity.value}set opacity(t){t=i(t,0,1),this.opacity!=t&&(this.observables.opacity.value=t)}get isVisible(){return this.observables.isVisible.value}set isVisible(t){this.isVisible!=t&&(this.observables.isVisible.value=t,this.notify("change-visibility",t),this.notify(t?"show":"hide"))}addObserver(t,e,s){this.#m.addObserver(t,e,s)}removeObserver(t,e,s){return this.#m.removeObserver(t,e,s)}notify(t,e){this.#m.notify(t,e)}serialize(){return{x:0,y:0,width:this.width,height:this.height,opacity:this.opacity,isVisible:this.isVisible,data:this.canvas.toDataURL()}}static deserialize(t){const e=t,s=(e.x,e.y,e.width),i=e.height,n=e.opacity,r=e.isVisible,o=new B(s,i);o.opacity=n,o.isVisible=r;const a=e.data;return new Promise(((t,e)=>{const s=new Image;s.onload=()=>{o.context.drawImage(s,0,0),t(o)},s.onerror=t=>{e(t)},s.src=a}))}}!function(t){t.structure={x:"number",y:"number",width:"number",height:"number",opacity:"number",isVisible:"boolean",data:"string"}}(B||(B={}));const T=B;class M extends l{#v=[];observables;constructor(t,e,s,i){super(),this.observables={width:new E(t),height:new E(e),backgroundColor:new R(255,255,255)},void 0===s||0==s.length?this.#v.push(new T(t,e)):this.#v.push(...s),i&&this.observables.backgroundColor.set(i)}get width(){return this.observables.width.value}get height(){return this.observables.height.value}setSize(t,e){t==this.width&&e==this.height||(this.observables.width.value=t,this.observables.height.value=e,this.notify("change-size",this))}get layers(){return this.#v}get backgroundColor(){return this.observables.backgroundColor.value}serialize(){const t={version:100,title:"",width:this.width,height:this.height,backgroundColor:this.backgroundColor.serialize(),layers:[]};for(const e of this.#v)t.layers.push(e.serialize());return t}static async deserialize(t){const e=t,s=e.width,i=e.height,n=h.deserialize(e.backgroundColor),r=[];for(const t of e.layers){const e=await T.deserialize(t);r.push(e)}return new M(s,i,r,n)}}!function(t){t.structure={version:"number",title:"string",width:"number",height:"number",backgroundColor:h.structure,layers:[T.structure]}}(M||(M={}));const D=M,F=class{#A=0;#p=0;#f=new s;get offsetX(){return this.#A}get offsetY(){return this.#p}set offsetX(t){this.#A=t}set offsetY(t){this.#p=t}offset(t,e){this.#A+=t,this.#p+=e}get isEmpty(){return this.#f.isEmpty()}normalize(){return this.#f.offset(this.#A,this.#p),this.#A=0,this.#p=0,this}set(t){return this.#f.set(t.boudingRect()),this.#A=t.#A,this.#p=t.#p,this}setRect(t){return this.#f.set(t),this.#A=0,this.#p=0,this}boudingRect(){return this.#f.copy().offset(this.#A,this.#p)}drawTo(t,e){const i=this.#f.copy().offset(this.#A,this.#p).scale(t.scale).intersection(new s(1,1,t.documentWidth*t.scale-2,t.documentHeight*t.scale-2)).floor(),n=t.getCanvasTopLeft();e.save(),e.translate(n.left,n.top),e.lineWidth=1,e.strokeStyle="black",e.lineDashOffset=i.x+i.y,e.setLineDash([5]),e.strokeRect(i.x-.5,i.y-.5,i.width+1,i.height+1),e.strokeStyle="white",e.lineDashOffset=5+i.x+i.y,e.strokeRect(i.x-.5,i.y-.5,i.width+1,i.height+1),e.restore()}isPointIn(t,e){return this.boudingRect().isPointIn2f(t,e)}clipBegin(t){t.save();const e=new Path2D,s=this.boudingRect();e.rect(s.x,s.y,s.width,s.height),t.clip(e)}clipEnd(t){t.restore()}};class I{cursor(t,e,s){return"none"}get resizeable(){return!1}get cancelable(){return!0}get hasStroke(){return!1}get hasPreview(){return!1}renderPreview(t,e,s){}get hasOverlay(){return!1}renderOverlay(t,e){}get isEnabledForHiddenLayer(){return!1}onDown(t,e,s,i,n){}onDrag(t,e,s,i,n){}onUp(t,e,s,i,n){}onCancel(t){}onKeyDown(t){}}class L extends I{get name(){return"none"}get size(){return 0}set size(t){}}!function(t){t.none=new L,t.Brush=class extends t{penMode;obaservables;constructor(t,e){super(),this.obaservables={size:new E(e),opacity:new E(1),blur:new E(1)},this.penMode=t}get name(){return this.penMode}cursor(t,e,s){return"brush"}get size(){return this.obaservables.size.value}set size(t){t=Math.max(t,1),this.obaservables.size.value=t}get resizeable(){return!0}get cancelable(){return!1}get opacity(){return this.obaservables.opacity.value}set opacity(t){this.obaservables.opacity.value=t}get blur(){return this.obaservables.blur.value}set blur(t){this.obaservables.blur.value=t}get composite(){return"pen"==this.penMode?"source-over":"destination-out"}get hasStroke(){return!0}onUp(t,e,s){this.finishDraw(t)}onCancel(t){this.finishDraw(t)}finishDraw(t){t.drawPath(t.strokePath,new w(this.size,t.foreColor,this.composite))}get hasPreview(){return!0}renderPreview(t,e,s){t.clipBegin(s.context),C(s.context,new w(this.size,t.foreColor,this.composite),t.strokePath),t.clipEnd(s.context)}},t.Scroll=class extends t{#_=0;#w=0;#b=0;#y=0;get name(){return"scroll"}cursor(t,e,s){return"grab"}get size(){return 1}set size(t){}get resizeable(){return!1}get cancelable(){return!1}onDown(t,e,s,i,n){this.#_=i,this.#w=n,this.#b=t.scrollX,this.#y=t.scrollY}onDrag(t,e,s,i,n){const r=i-this.#_,o=n-this.#w;t.scrollX=this.#b-r,t.scrollY=this.#y-o}onUp(t,e,s,i,n){const r=i-this.#_,o=n-this.#w;t.scrollX=this.#b-r,t.scrollY=this.#y-o}},t.Spoit=class extends t{get name(){return"spoit"}cursor(t,e,s){return"spoit"}get size(){return 1}set size(t){}get isEnabledForHiddenLayer(){return!0}onDown(t,e,s){t.execSpoit(e,s)}onDrag(t,e,s){t.execSpoit(e,s)}},t.Select=class extends t{#_=0;#w=0;#C=0;#x=0;#k=null;#S=null;#E="select";get name(){return"select"}cursor(t,e,s){if("select"==this.#E)return"select";if("grab"==this.#E)return"grab";const i=t.selectedRegion;return null==i?"select":i.isPointIn(e,s)?"grab":"select"}get size(){return 1}set size(t){}get cancelable(){return!1}get isEnabledForHiddenLayer(){return!0}get hasPreview(){return!0}renderPreview(t,e,s){this.#E}get hasOverlay(){return!0}renderOverlay(t,e){if("select"==this.#E){const i=new s(this.#_,this.#w,this.#C-this.#_,this.#x-this.#w).normalize().scale(t.scale).floor().expand(.5),n=t.getCanvasTopLeft();e.save(),e.translate(n.left,n.top),e.lineWidth=1,e.strokeStyle="black",e.setLineDash([5]),e.strokeRect(i.x,i.y,i.width,i.height),e.strokeStyle="white",e.lineDashOffset=5,e.strokeRect(i.x,i.y,i.width,i.height),e.restore()}}onDown(t,e,s){const i=t.selectedRegion;this.#_=this.#C=0|e,this.#w=this.#x=0|s,null!=i&&i.isPointIn(e,s)?(this.#E="grab",t.selectGrab()):(this.#E="select",this.#S=null)}onDrag(t,e,s){s|=0;const i=(e|=0)-this.#C,n=s-this.#x;this.#C=e,this.#x=s,"grab"==this.#E&&t.selectGrabMove(i,n)}onUp(t,e,i){if(this.#C=0|e,this.#x=0|i,"select"==this.#E){const e=new s(this.#_,this.#w,this.#C-this.#_,this.#x-this.#w).normalize().intersection(new s(0,0,t.documentWidth,t.documentHeight));if(e.isEmpty())t.selectNew(null);else{const s=(new F).setRect(e);t.selectNew(s)}}else this.#E;this.#E="none"}onCancel(t){"grab"==this.#E&&t.selectGrabFinish(),this.#E="none"}};class e extends t{obaservables;constructor(){super(),this.obaservables={tolerance:new E(0),closeGap:new E(0),expand:new E(1),opacity:new E(1)}}get name(){return"bucket"}cursor(t,e,s){return"bucket"}get size(){return 1}set size(t){}get cancelable(){return!0}get tolerance(){return this.obaservables.tolerance.value}set tolerance(t){this.obaservables.tolerance.value=t}get closeGap(){return this.obaservables.closeGap.value}set closeGap(t){this.obaservables.closeGap.value=t}get expand(){return this.obaservables.expand.value}set expand(t){this.obaservables.expand.value=t}get opacity(){return this.obaservables.opacity.value}set opacity(t){this.obaservables.opacity.value=t}onDown(t,e,s){t.bucketFill(t.currentLayer,e,s,t.foreColor,{closeGap:this.closeGap,expand:this.expand,tolerance:this.tolerance,opacity:this.opacity})}}t.Bucket=e,function(t){t.toleranceMax=200}(e=t.Bucket||(t.Bucket={}))}(I||(I={}));const z=I,O=class{#R="";add(t,e){let s="";for(const t in e){const i=e[t];let n;n="number"==typeof i?i.toString():"string"==typeof i?i:i instanceof Array?i.join(" "):i.css(),s+=`${t}="${n}" `}this.#R+=`<${t} ${s}/>\n`}get code(){return this.#R}},Y=class{#B;#T;#M;#D;constructor(t=128,e=128){this.#B=t,this.#T=e;const s=P.singleton.gl;var i=s.createFramebuffer();if(null==i)throw new Error("Failed to createFramebuffer");this.#M=i;var n=s.createTexture();if(null==n)throw new Error("Failed to createTexture");this.#D=n,s.bindFramebuffer(s.FRAMEBUFFER,i),s.bindTexture(s.TEXTURE_2D,n),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,t,e,0,s.RGBA,s.UNSIGNED_BYTE,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,n,0),s.bindTexture(s.TEXTURE_2D,null),s.bindFramebuffer(s.FRAMEBUFFER,null)}get buffer(){return this.#M}get texture(){return this.#D}get width(){return this.#B}get height(){return this.#T}setSize(t,e){const s=P.singleton.gl;s.bindTexture(s.TEXTURE_2D,this.texture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,t,e,0,s.RGBA,s.UNSIGNED_BYTE,null),s.bindTexture(s.TEXTURE_2D,null),this.#B=t,this.#T=e}setImage(t){const e=P.singleton.gl;e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.bindTexture(e.TEXTURE_2D,null),this.#B=t.width,this.#T=t.height}};let U;class X{canvas;gl;vertexShader;#F;#I;constructor(){U=this,this.canvas=document.createElement("canvas");const t=this.canvas.getContext("webgl2");if(null===t)throw new Error("Failed to get WebGL2RenderingContext");this.gl=t;const e=t.createShader(t.VERTEX_SHADER);if(null==e)throw new Error("Failed to create vertex shader.");if(t.shaderSource(e,"\nattribute vec2 aPosition;\nvoid main(void) {\n  gl_Position = vec4(aPosition.x, aPosition.y, 0, 1.0);\n}\n"),t.compileShader(e),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error("Failed to compile vertex shader."+t.getShaderInfoLog(e));this.vertexShader=e;const s=t.createBuffer();if(null==s)throw new Error("Failed to create VBO");const i=new Float32Array([-1,1,1,1,-1,-1,1,-1]);t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW);const n=t.createBuffer();if(null==n)throw new Error("Failed to create IBO");t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n);const r=new Int16Array([0,1,2,3,2,1]);t.bufferData(t.ELEMENT_ARRAY_BUFFER,r,t.STATIC_DRAW),t.activeTexture(t.TEXTURE0),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.clearColor(0,0,0,0),this.#F=new Y,this.#I=new Y}static get singleton(){return void 0===U&&(U=new X),U}get dstBuffer(){return this.#F}get srcBuffer(){return this.#I}swapBuffer(){const t=this.#I;this.#I=this.#F,this.#F=t}compile(t,e){const s=this.gl,i=s.createShader(s.FRAGMENT_SHADER);if(null==i)throw new Error("Failed to create fragment shader.");if(s.shaderSource(i,t),s.compileShader(i),!s.getShaderParameter(i,s.COMPILE_STATUS))throw new Error("Failed to compile fragment shader."+s.getShaderInfoLog(i));const n=s.createProgram();if(null==n)throw new Error("Failed to create program.");if(s.attachShader(n,this.vertexShader),s.attachShader(n,i),s.linkProgram(n),!s.getProgramParameter(n,s.LINK_STATUS))throw new Error("Failed to link program. "+s.getProgramInfoLog(n));const r=s.getAttribLocation(n,"aPosition");s.enableVertexAttribArray(r),s.vertexAttribPointer(r,2,s.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT,0);const o={};e||(e=[]),e.push({name:"texture",type:"int"},{name:"texWidth",type:"float"},{name:"texHeight",type:"float"});for(let t of e){let e=s.getUniformLocation(n,t.name);o[t.name]={name:t.name,type:t.type,location:e}}return{program:n,uniforms:o}}}const P=X,W=class{program;uniforms;constructor(t,e){const s=P.singleton.compile(t,e);this.program=s.program,this.uniforms=s.uniforms}setUniform(t,e){const s=this.uniforms[t];if(void 0===s||null==s.location)return;const i=P.singleton.gl;switch(s.type){case"vec4":i.uniform4fv(s.location,e);break;case"vec3":i.uniform3fv(s.location,e);break;case"float":i.uniform1f(s.location,e);break;case"int":i.uniform1i(s.location,e)}}};let G;class V extends W{constructor(){super("\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float texWidth;\nuniform float texHeight;\n\nuniform vec3 maskColor;\nuniform float tolerance;\n\nvoid main(void){\n  vec2 tFrag = vec2(1.0 / texWidth, 1.0 / texHeight);\n  vec2 st = gl_FragCoord.st * tFrag;\n  vec4 texColor = texture2D(texture, st);\n  vec3 d = (maskColor/255.0 - texColor.rgb);\n  vec3 d2 = d * d;\n  const float L = 255.0*255.0;\n  float a = L*(d2.r + d2.g + d2.b - 3.0*tolerance) - 3.0;\n\n  gl_FragColor = vec4(0.0, 0.0, 0.0, a);\n}\n",[{name:"maskColor",type:"vec3"},{name:"tolerance",type:"float"}])}static get singleton(){return void 0===G&&(G=new V),G}}const Q=V;let N;class H extends W{constructor(){super("\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float texWidth;\nuniform float texHeight;\n\nuniform float size;\n\nvoid main(void){\n  vec2 tFrag = vec2(1.0 / texWidth, 1.0 / texHeight);\n  float a = 0.0;\n  float lower = -floor(size);\n  float upper = ceil(size);\n  for (float y = -5.0; y <= 5.0; y++) {\n    for (float x = -5.0; x <= 5.0; x++) {\n      a += (lower <= y && y <= upper && lower <= x && x <= upper) ? texture2D(texture, (gl_FragCoord.st + vec2(x, y)) * tFrag).a : 0.0;\n    }\n  }\n  gl_FragColor  = vec4(0.0, 0.0, 0.0, a);\n}\n",[{name:"size",type:"float"}])}static get singleton(){return void 0===N&&(N=new H),N}}const K=H;let Z;class q extends W{constructor(){super("\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float texWidth;\nuniform float texHeight;\n\nvoid main(void){\n  vec2 tFrag = vec2(1.0 / texWidth, 1.0 / texHeight);\n  vec2 st = gl_FragCoord.st * tFrag;\n  vec4 texColor = texture2D(texture, st);\n  gl_FragColor  = texColor;\n}\n",[])}static get singleton(){return void 0===Z&&(Z=new q),Z}}const J=q;let j;class $ extends W{constructor(){super("\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float texWidth;\nuniform float texHeight;\n\nvoid main(void){\n  vec2 tFrag = vec2(1.0 / texWidth, 1.0 / texHeight);\n  vec2 st = gl_FragCoord.st * tFrag;\n  float a = texture2D(texture, st).a;\n  gl_FragColor  = vec4(0.0, 0.0, 0.0, 1.0 - a);\n}\n",[])}static get singleton(){return void 0===j&&(j=new $),j}}const tt=$;let et;class st extends W{constructor(){super("\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float texWidth;\nuniform float texHeight;\n\nuniform vec3 paintColor;\n\nvoid main(void){\n  vec2 tFrag = vec2(1.0 / texWidth, 1.0 / texHeight);\n  vec2 st = gl_FragCoord.st * tFrag;\n  float a = texture2D(texture, st).a;\n\n  gl_FragColor = vec4(paintColor/255.0, a);\n}\n",[{name:"paintColor",type:"vec3"}])}static get singleton(){return void 0===et&&(et=new st),et}}const it={identity:J,invert:tt,"color-mask":Q,expand:K,paint:st};var nt;!function(t){t.init=function(){P.singleton},t.drawImageWithFilters=function(t,e,s){const i=P.singleton,n=i.gl,r=e.width,o=e.height;i.canvas.width=r,i.canvas.height=o,i.srcBuffer.setImage(e),i.dstBuffer.setSize(r,o);for(let t=0;t<s.length;t++){const e=s[t],a=it[e.filter].singleton;if(n.useProgram(a.program),t==s.length-1?n.bindFramebuffer(n.FRAMEBUFFER,null):n.bindFramebuffer(n.FRAMEBUFFER,i.dstBuffer.buffer),n.viewport(0,0,r,o),n.clear(n.COLOR_BUFFER_BIT),a.setUniform("texWidth",r),a.setUniform("texHeight",o),e.uniforms)for(const t in e.uniforms)a.setUniform(t,e.uniforms[t]);n.bindTexture(n.TEXTURE_2D,i.srcBuffer.texture),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0),i.swapBuffer()}n.bindTexture(n.TEXTURE_2D,null),n.finish(),t.save(),t.scale(1,-1),t.drawImage(i.canvas,0,-o),t.restore()}}(nt||(nt={}));const rt=nt;function ot(t){return"mouse"==t.pointerType?`mouse-${t.button>=0?t.button:0}`:`${t.pointerType}-${t.pointerId}`}const at=new class{#L=null;#z=null;#O={pointers:[]};#Y=new Map;#U=new WeakMap;tapDuration=300;dragThreshold=5;get currentTarget(){return this.#L}init(){window.addEventListener("pointermove",(t=>{const e=ot(t),s=this.#Y.get(e);if(!s)return;const i=this.#L.getBoundingClientRect();s.clientX=t.clientX,s.clientY=t.clientY,s.x=t.clientX-i.x,s.y=t.clientY-i.y;const n=this.#O.pointers;if(null==this.#z){if(s.dragged)return;if(r=s.startClientX,o=s.startClientY,((a=t.clientX)-r)*(a-r)+((h=t.clientY)-o)*(h-o)<this.dragThreshold*this.dragThreshold)return;s.dragged=!0;let e=!0;for(let t=0;t<n.length;t++)if(!n[t].dragged){e=!1;break}if(!e)return;const i=this.#Y.size;if(1==i)this.#z="drag",this.#X("drag-start");else{if(2!=i)return void this.#P();this.#z="2finger-drag",this.#X("2finger-drag-start")}}var r,o,a,h;this.#X(this.#z+"-move")})),window.addEventListener("pointerup",(t=>{const e=ot(t),s=this.#Y.get(e);if(!s)return;const i=this.#L.getBoundingClientRect();s.clientX=t.clientX,s.clientY=t.clientY,s.x=t.clientX-i.x,s.y=t.clientY-i.y,s.alive=!1;const n=Date.now(),r=this.#O.pointers[0];if(1==this.#Y.size)return null==this.#z&&n<r.startTime+this.tapDuration?this.#X("tap"):"drag"==this.#z&&this.#X("drag-end"),void this.#P();let o=!0;const a=this.#O.pointers;for(let t=0,e=a.length;t<e;t++)if(a[t].alive){o=!1;break}o&&(null==this.#z?n<r.startTime+this.tapDuration&&(2==this.#Y.size?this.#X("2finger-tap"):3==this.#Y.size&&this.#X("3finger-tap")):this.#X(this.#z+"-end"),this.#P())})),window.addEventListener("pointercancel",(t=>{const e=ot(t);this.#Y.get(e)&&this.#z&&(this.#X(this.#z+"-cancel"),this.#P())}))}#P(){this.#L=null,this.#O.pointers=[],this.#Y.clear(),this.#z=null}#X(t){if(null==this.#L)return;const e=this.#U.get(this.#L);if(!e)return;const s=e.get(t);s&&s(this.#O)}listen(t,e,s){this.#W(t).set(e,s)}#W(t){let e=this.#U.get(t);return e||(e=new Map,this.#U.set(t,e),t.addEventListener("pointerdown",(e=>{if(null!=this.#z)return;if(null!=this.#L&&this.#L!=t)return;if("mouse"==e.pointerType&&0!=e.button)return;const s=ot(e);this.#L=t,this.#Y.has(s);const i=t.getBoundingClientRect(),n=e.clientX-i.x,r=e.clientY-i.y,o={id:s,startTime:Date.now(),startX:n,startY:r,startClientX:e.clientX,startClientY:e.clientY,x:n,y:r,clientX:e.clientX,clientY:e.clientY,alive:!0,dragged:!1};this.#O.pointers.push(o),this.#Y.set(s,o),1!=this.#O.pointers.length||"mouse"!=e.pointerType&&"pen"!=e.pointerType||(this.#z="drag",o.dragged=!0,this.#X("drag-start"))})),e)}get centerOfActivePointers(){const t=this.#O.pointers,e=t.length;if(0==e)return{x:0,y:0};let s=0,i=0;for(let n=0;n<e;n++)s+=t[n].clientX,i+=t[n].clientY;return{x:s/e,y:i/e}}};at.init();const ht=at;function lt(t,e){if(void 0===window.OffscreenCanvas){const s=document.createElement("canvas");return s.width=t,s.height=e,s}return new OffscreenCanvas(t,e)}const ct=new Int8Array([0,0,-9,0,-8,0,-7,0,-6,0,-5,0,5,0,6,0,7,0,8,0,9,0,0,-9,0,-8,0,-7,0,-6,0,-5,0,5,0,6,0,7,0,8,0,9]),ut=new ImageData(19,19),dt=function(t){const e=document.createElement("template");e.innerHTML='<svg width="0px" height="0px" xmlns="http://www.w3.org/2000/svg" version="1.1">\n  <defs>\n    <filter id="tegaki-canvas-svg-filter">\n    </filter>\n  </defs>\n</svg>\n';const s=e.content.firstElementChild;if(!(s instanceof SVGElement))throw new Error("First element must be SVG ELement");return s}();document.body.appendChild(dt);const gt=_.sharedPoolFor(m),At={grab:{cursor:"grab"},spoit:{cursor:`url(${u("cursor-spoit.png")}) 1 14, auto`},bucket:{cursor:`url(${u("cursor-bucket.png")}) 2 12, auto`},prohibit:{cursor:`url(${u("cursor-prohibit.png")}) 7 7, auto`},select:{cursor:`url(${u("cursor-select.png")}) 7 7, auto`}};class pt{action;undo;time=Date.now();constructor(t,e){this.action=t,this.undo=e}dispose(){this.action.dispose(),this.undo.dispose()}mergeWith(t,e){const s=t.action,i=this.action,n=t.undo,r=this.undo;if(t.time-this.time<3e3){if(s instanceof x.ChangeLayerOpacity&&i instanceof x.ChangeLayerOpacity&&n instanceof x.ChangeLayerOpacity&&r instanceof x.ChangeLayerOpacity&&s.layer==i.layer)return new pt(new x.ChangeLayerOpacity(s.canvas,s.layer,i.opacity),new x.ChangeLayerOpacity(s.canvas,s.layer,n.opacity));if(s instanceof x.ChangeBackgroundColor&&i instanceof x.ChangeBackgroundColor&&n instanceof x.ChangeBackgroundColor&&r instanceof x.ChangeBackgroundColor)return new pt(new x.ChangeBackgroundColor(s.canvas,i.color),new x.ChangeBackgroundColor(s.canvas,n.color));if(s instanceof x.SelectMove&&i instanceof x.SelectMove&&n instanceof x.SelectMove&&r instanceof x.SelectMove){const t=s.x+i.x,e=s.y+i.y;return new pt(new x.SelectMove(s.canvas,t,e),new x.SelectMove(s.canvas,-t,-e))}}if(s instanceof x.DrawPath&&i instanceof x.DrawPath&&i.startTime-s.finishTime<=e&&s.layer==i.layer){const t=new x.Merge(s,i),e=new x.Merge(r,n);return new pt(t,e)}if(s instanceof x.Merge&&i instanceof x.DrawPath&&n instanceof x.Merge&&s.last instanceof x.DrawPath&&i.startTime-s.last.finishTime<=e&&s.last.layer==i.layer)return s.add(i),n.unshift(r),new pt(s,n)}}function mt(t,e,s){document.getElementById("tegaki-canvas-svg-filter").innerHTML=s,t.save(),t.filter="url(#tegaki-canvas-svg-filter)",t.drawImage(e,0,0),t.restore()}let vt;function ft(t,e=0,s=0,i=t.width,n=t.height){void 0===vt?vt=lt(i,n):(vt.width=i,vt.height=n);const r=vt.getContext("2d",{willReadFrequently:!0});if(null==r)throw new Error("Failed to get RenderingContext2D");return r.drawImage(t,e,s,i,n,0,0,i,n),r.getImageData(0,0,i,n)}const _t=class extends l{element;cursorOverlay;cursorContext;canvas;context;_currentTool=z.none;_nextTool=null;_innerScale;_offscreen;_currentLayerOffscreen;_scale=1;_mouseX=0;_mouseY=0;_isMouseEnter=!1;_activePointerId=null;_scrollX=0;_scrollY=0;_renderCallback;_renderCursorCallback;_undoStack=new t;_redoStack=new t;_undoMax=20;_strokeMergeTime=150;_strokeManager=new S;_spoitContext;_currentLayerPosition=0;_selectedRegion=null;viewBackgroundColor=new h(255,255,238);renderCusorAsCircleThreshold=8;observables;constructor(t){super();const e=new D(t.width,t.height,[],t.backgroundColor);this._innerScale=1,this.observables={document:new E(e),foreColor:new R(255,255,255).set(t.foreColor)},this.element=document.createElement("div"),this.element.className="dt_r_tegaki-canvas",this.canvas=document.createElement("canvas"),this.canvas.className="dt_r_layer",this.canvas.width=this.documentWidth,this.canvas.height=this.documentHeight,this._renderCallback=this.render.bind(this);const s=this.canvas.getContext("2d");if(null===s)throw new Error("Failed to get CanvasRendering2DContext");this.context=s,this.cursorOverlay=document.createElement("canvas"),this.cursorOverlay.className="dt_r_cursor",this.cursorOverlay.width=this.documentWidth,this.cursorOverlay.height=this.documentHeight,this._renderCursorCallback=this.renderCursor.bind(this);let i=this.cursorOverlay.getContext("2d");if(null===i)throw new Error("Failed to get CanvasRendering2DContext");this.cursorContext=i,this.element.appendChild(this.canvas),this.element.appendChild(this.cursorOverlay),this._offscreen=new m(this.innerWidth,this.innerHeight),this._currentLayerOffscreen=new m(this.innerWidth,this.innerHeight);const n=lt(1,1).getContext("2d",{willReadFrequently:!0});if(null===n)throw new Error("Failed to get CanvasRendering2DContext");this._spoitContext=n,this.init()}get document(){return this.observables.document.value}set document(t){this.document!=t&&(this.observables.document.value=t,this.notify("change-document",this.document),this.notify("change-document-size",this.document),this.notify("change-background-color",this.backgroundColor),this.selectLayerAt(this.document.layers.length-1))}get foreColor(){return this.observables.foreColor.color}set foreColor(t){this.observables.foreColor.set(t)}get currentLayer(){return this.document.layers[this._currentLayerPosition]}get currentLayerPosition(){return this._currentLayerPosition}get selectedRegion(){return this._selectedRegion}set selectedRegion(t){this._selectedRegion=t}get strokeManager(){return this._strokeManager}get strokePath(){return this._strokeManager.path}get layers(){return this.document.layers}get currentTool(){return this._currentTool}set currentTool(t){this.isDrawing?this._nextTool=t:this._currentTool!=t&&(this._currentTool=t,this.requestRenderCursor(),this.notify("change-tool",this._currentTool))}get documentWidth(){return this.document.width}get documentHeight(){return this.document.height}get canvasWidth(){return this.document.width*this.scale}get canvasHeight(){return this.document.height*this.scale}setDocumentSize(t,e){this.documentWidth==t&&this.documentHeight==e||(this.document.setSize(t,e),this.adjustScroll(),this.notify("change-document-size",{width:t,height:e}))}get backgroundColor(){return this.document.backgroundColor}set backgroundColor(t){this.document.backgroundColor.equals(t)||(this.document.observables.backgroundColor.set(t),this.notify("change-background-color",t))}get innerScale(){return this._innerScale}get innerWidth(){return this.documentWidth*this._innerScale}get innerHeight(){return this.documentHeight*this._innerScale}get width(){return this.canvas.width}get height(){return this.canvas.height}get scale(){return this._scale}set scale(t){if(t<=0)throw new RangeError("Invalid Argument: scale must be greater than 0.");if(t=i(t,this.minScale,this.maxScale),this.scale==t)return;const e=this._scale;this._scale=t,this.adjustScroll(),this.requestRender(),this.notify("change-scale",{scale:t,old:e})}get minScale(){const t=this.canvas.width/this.document.width,e=this.canvas.height/this.document.height;return Math.min(1,t,e)}get maxScale(){return 32}get overallScale(){const t=this.canvas.width/this.document.width,e=this.canvas.height/this.document.height;return Math.min(t,e)}fitScaleToOverall(){this.scale=this.overallScale}zoomAtPointer(t,e){const s=this.scale;let i=this.scale*t;(s<1&&i>1||s>1&&i<1)&&(i=1),this.scale=i}get scrollXMax(){return Math.abs(this.document.width*this.scale-this.width)/2|0}get scrollXMin(){return-this.scrollXMax}get scrollYMax(){return Math.abs(this.document.height*this.scale-this.height)/2|0}get scrollYMin(){return-this.scrollYMax}get scrollX(){return this._scrollX}set scrollX(t){t=i(t,this.scrollXMin,this.scrollXMax),this._scrollX!=t&&(this._scrollX=t,this.requestRender(),this.notify("scroll"))}get scrollY(){return this._scrollY}set scrollY(t){t=i(t,this.scrollYMin,this.scrollYMax),this._scrollY!=t&&(this._scrollY=t,this.requestRender(),this.notify("scroll"))}adjustScroll(){this.scrollX=this.scrollX,this.scrollY=this.scrollY}get visibleWidth(){return this.width/(this.document.width*this.scale)}get visibleHeight(){return this.height/(this.document.height*this.scale)}get undoLength(){return this._undoStack.length}get redoLength(){return this._redoStack.length}get undoMax(){return this._undoMax}set undoMax(t){t<0||(this._undoMax=t)}get strokeMergeTime(){return this._strokeMergeTime}set strokeMergeTime(t){t<0||(this._strokeMergeTime=t)}get toolSize(){return this._currentTool.size}get toolColor(){return this.foreColor}get isDrawing(){return ht.currentTarget==this.cursorOverlay}setSize(t,e){this.canvas.width=t,this.canvas.height=e,this.cursorOverlay.width=t,this.cursorOverlay.height=e,this.scale=this.scale,this.adjustScroll(),this.requestRender(),this.requestRenderCursor()}download(){const t=document.createElement("a"),e=`tegaki-${Date.now()}.png`;t.setAttribute("download",e),t.setAttribute("href",this._offscreen.canvas.toDataURL()),t.click()}copyToClipboard(){return new Promise(((t,e)=>{this._offscreen.canvas.toBlob((s=>{if(null!=s)try{const e=`<img src="tegaki-${Date.now()}.png">`;navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([e],{type:"text/html"}),"image/png":s})]),t()}catch(t){e(t)}else e(new Error("Failed to get blob from canvas"))}))}))}_needsRenderCursor=!1;requestRenderCursor(){this._needsRenderCursor||(this._needsRenderCursor=!0,requestAnimationFrame(this._renderCursorCallback))}_cursorRect=new e(0,0,0,0);_cursorName="none";renderCursor(){this._needsRenderCursor=!1;const t=this.cursorContext;if(t.clearRect(this._cursorRect.x,this._cursorRect.y,this._cursorRect.width,this._cursorRect.height),!this._isMouseEnter)return void(this._cursorRect.width=0);let e;const s={x:this._mouseX,y:this._mouseY};if(e=this.currentLayer.isVisible||this._currentTool.isEnabledForHiddenLayer?this._currentTool.cursor(this,s.x,s.y):"prohibit","brush"==e){e="none";const i=0,n=this.currentTool.size*this.scale;let r,o,a,h;s.x=s.x+i,s.y=s.y+i,this.getCanvasTopLeft(),t.save(),n>=this.renderCusorAsCircleThreshold?(r=s.x-n/2-2,o=s.y-n/2-2,a=h=n+4,this.#G(s.x,s.y,n)):(r=s.x-9,o=s.y-9,a=h=19,this.#V(s.x,s.y)),t.restore(),this._cursorRect.set4f(r,o,a,h).expand(1)}if(this._cursorName!=e){this._cursorName=e;const t=At[e];this.cursorOverlay.style.cursor=void 0===t?"none":`${t.cursor}`}}#V(t,e){const s=Math.max(t+-9,0),i=Math.max(e+-9,0),n=Math.min(t+-9+19,this.width)-s,r=Math.min(e+-9+19,this.height)-i;if(n<=0||r<=0)return;const o=this.context.getImageData(s,i,n,r).data,a=ut.data,h=t-s,l=e-i,c=ct,u=c.length;for(let t=0;t<u;t+=2){const e=h+c[t];if(e<0)continue;const s=l+c[t+1];if(s<0)continue;const i=4*(s*n+e),r=4*(19*s+e);a[r]=o[i]>127?0:255,a[r+1]=o[i+1]>127?0:255,a[r+2]=o[i+2]>127?0:255,a[r+3]=255}this.cursorContext.putImageData(ut,s,i),a.fill(0)}#Q=0;#N=new Int16Array;#H=new ImageData(1,1);#G(t,e,s){s=Math.ceil(s);const i=-Math.ceil(s/2),n=Math.max(t+i,0),r=Math.max(e+i,0),o=Math.min(t+i+s+1,this.width)-n,a=Math.min(e+i+s+1,this.height)-r;if(o<=0||a<=0)return;const h=this.context.getImageData(n,r,o,a).data,l=s+1;let c,u;this.#Q!=s?(u=this.#N=function(t){const e=[],s=t*t;let i=1,n=t;for(e.push(0,t,0,-t,t,0,-t,0);;){if(!(i<n)){if(i==n){e.push(i,n),e.push(-i,n),e.push(i,-n),e.push(-i,-n);break}break}e.push(i,n),e.push(-i,n),e.push(i,-n),e.push(-i,-n),e.push(n,i),e.push(-n,i),e.push(n,-i),e.push(-n,-i),i++,n=Math.round(Math.sqrt(s-i*i))}return new Int16Array(e)}(s/2),c=this.#H=new ImageData(l,l),this.#Q=s):(u=this.#N,c=this.#H);const d=c.data,g=t-n,A=e-r,p=u.length;for(let t=0;t<p;t+=2){const e=g+u[t];if(e<0)continue;const s=A+u[t+1];if(s<0)continue;const i=4*(s*o+e),n=4*(s*l+e);d[n]=h[i]>127?0:255,d[n+1]=h[i+1]>127?0:255,d[n+2]=h[i+2]>127?0:255,d[n+3]=255}this.cursorContext.putImageData(c,n,r),d.fill(0)}_needsRender=!1;requestRender(){this._needsRender||(this._needsRender=!0,requestAnimationFrame(this._renderCallback))}render(){const t=this._offscreen.context,e=this.context;this._offscreen.width==this.innerWidth&&this._offscreen.height==this.innerHeight||(this._offscreen.width=this.innerWidth,this._offscreen.height=this.innerHeight),this._offscreen.fill(this.backgroundColor),t.save(),t.imageSmoothingEnabled=!1;for(let e=0;e<this.layers.length;e++){const s=this.layers[e];if(!s.isVisible)continue;const i=s.opacity;t.globalAlpha=i,e==this._currentLayerPosition&&this.isDrawing&&this._currentTool.hasPreview?(this._currentLayerOffscreen.set(s),this._currentTool.renderPreview(this,s,this._currentLayerOffscreen),t.drawImage(this._currentLayerOffscreen.canvas,0,0)):t.drawImage(s.canvas,0,0)}t.restore(),e.save(),e.fillStyle=this.viewBackgroundColor.css(),e.fillRect(0,0,this.width,this.height),e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high";const s=this.getCanvasTopLeft();e.translate(s.left,s.top),e.scale(this._scale/this._innerScale,this._scale/this._innerScale),e.drawImage(this._offscreen.canvas,0,0),e.restore(),this.isDrawing&&this._currentTool.hasOverlay&&this._currentTool.renderOverlay(this,e),null==this._selectedRegion||this._selectedRegion.isEmpty||this._selectedRegion.drawTo(this,this.context),this.renderScrollbar(),this._needsRender=!1}renderScrollbar(){const t=this.context,e=this.document.width*this.scale,s=this.document.height*this.scale;if(this.visibleWidth<1){const s=this.width*((this.scrollX-this.scrollXMin)/e),i=this.width*this.visibleWidth;t.fillStyle="rgba(64, 0, 0, 0.6)",t.fillRect(s,this.height-2,i,2)}if(this.visibleHeight<1){const e=this.height*((this.scrollY-this.scrollYMin)/s),i=this.height*this.visibleHeight;t.fillStyle="rgba(64, 0, 0, 0.6)",t.fillRect(this.width-2,e,2,i)}}init(){ht.listen(this.cursorOverlay,"drag-start",(t=>{this._mouseX=t.pointers[0].startX,this._mouseY=t.pointers[0].startY;const e=this.viewCoordToCanvasCoord(this._mouseX,this._mouseY);this._currentTool.hasStroke&&this._strokeManager.start(e.x,e.y),this._currentTool.onDown(this,e.x,e.y,this._mouseX,this._mouseY),this._currentTool.hasPreview&&this.requestRender()})),ht.listen(this.cursorOverlay,"drag-move",(t=>{this._isMouseEnter=!0,this._mouseX=t.pointers[0].x,this._mouseY=t.pointers[0].y;const e=this.viewCoordToCanvasCoord(this._mouseX,this._mouseY);this._currentTool.hasStroke&&this._strokeManager.move(e.x,e.y),this._currentTool.onDrag(this,e.x,e.y,this._mouseX,this._mouseY),(this._currentTool.hasPreview||this._currentTool.hasOverlay)&&this.requestRender(),this.requestRenderCursor()})),this.cursorOverlay.addEventListener("pointermove",(t=>{if(!this.isDrawing&&("mouse"==t.pointerType||"pen"==t.pointerType)){const e=this.cursorOverlay.getBoundingClientRect();this._mouseX=t.clientX-e.x,this._mouseY=t.clientY-e.y,this._isMouseEnter=!0,this.requestRenderCursor()}})),this.cursorOverlay.addEventListener("pointerleave",(t=>{"mouse"!=t.pointerType&&"pen"!=t.pointerType||(this._isMouseEnter=!1,this.requestRenderCursor())})),ht.listen(this.cursorOverlay,"drag-end",(t=>{this._activePointerId=null,this._mouseX=t.pointers[0].x,this._mouseY=t.pointers[0].y;const e=this.viewCoordToCanvasCoord(this._mouseX,this._mouseY);this._currentTool.hasStroke&&this._strokeManager.finish(),this._currentTool.onUp(this,e.x,e.y,this._mouseX,this._mouseY),(this._currentTool.hasPreview||this._currentTool.hasOverlay)&&this.requestRender(),null!=this._nextTool&&(this.currentTool=this._nextTool,this._nextTool=null)})),ht.listen(this.cursorOverlay,"drag-cancel",(t=>{this._currentTool.hasStroke&&this._strokeManager.finish(),this._currentTool.onCancel(this),(this._currentTool.hasPreview||this._currentTool.hasOverlay)&&this.requestRender(),null!=this._nextTool&&(this.currentTool=this._nextTool,this._nextTool=null)}));const t={x:0,y:0};ht.listen(this.cursorOverlay,"2finger-drag-start",(e=>{t.x=this.scrollX,t.y=this.scrollY})),ht.listen(this.cursorOverlay,"2finger-drag-move",(e=>{const s=e.pointers,i=(s[0].startX+s[1].startY)/2,n=(s[0].startY+s[1].startY)/2,r=(s[0].x+s[1].y)/2,o=(s[0].y+s[1].y)/2;this.scrollX=t.x-(r-i)/this.scale,this.scrollY=t.y-(o-n)/this.scale})),ht.listen(this.cursorOverlay,"2finger-tap",(t=>{this.undo()})),ht.listen(this.cursorOverlay,"3finger-tap",(t=>{this.redo()})),this._strokeManager.addObserver(this,"update",(()=>{this.requestRender()})),this.reset(this.documentWidth,this.documentHeight,this.backgroundColor,!0),this.requestRender()}execSpoit(t,e){void 0!==t&&void 0!==e||(t=this._mouseX,e=this._mouseY);const s=this.getColorAt(t,e);void 0!==s&&this.notify("spoit",{x:t,y:e,color:s})}getColorAt(t,e){if(e|=0,!((t|=0)<0||t>=this.innerWidth||e<0||e>=this.innerHeight))try{this._spoitContext.drawImage(this._offscreen.canvas,t,e,1,1,0,0,1,1);const s=this._spoitContext.getImageData(0,0,1,1).data;return new h(s[0],s[1],s[2])}catch{}}selectLayer(t){const e=this.layers.indexOf(t);if(-1==e)throw new Error("Specified layer is not found");this.selectLayerAt(e)}selectLayerAt(t){if(t>=this.layers.length)throw new RangeError("position must be less than layers.length");this._currentLayerPosition=t,this.notify("change-current-layer",{position:t,layer:this.currentLayer})}clipBegin(t){this._selectedRegion?.clipBegin(t)}clipEnd(t){this._selectedRegion?.clipEnd(t)}reset(t,e,s=h.white,i=!1){const n=new B(t*this.innerScale,e*this.innerScale),r=new D(t,e,[n],s),o=new x.ChangeDocument(this,r);if(i){const t=new x.None(this);this.pushAction(new pt(o,t)),this._undoStack.clear(),this.notify("update-history",this)}else{const t=this.document,e=new x.ChangeDocument(this,t);this.pushAction(new pt(o,e))}}changeBackgroundColor(t){const e=this.backgroundColor;if(t.equals(this.backgroundColor))return;const s=new x.ChangeBackgroundColor(this,t),i=new x.ChangeBackgroundColor(this,e);this.pushAction(new pt(s,i))}newLayer(t){if(t>this.layers.length||t<0)throw new RangeError("position is out of range");const e=new B(this.innerWidth,this.innerHeight),s=new x.DeleteLayer(this,t),i=new x.AddLayer(this,t,e);this.pushAction(new pt(i,s))}deleteLayer(t){const e=this.layers.indexOf(t);if(-1==e)throw new Error("Specified layer is not found");this.deleteLayerAt(e)}deleteLayerAt(t){if(t>=this.layers.length||t<0)throw new RangeError("position is out of range");if(1==this.layers.length)return;const e=this.layers[t],s=new x.AddLayer(this,t,e),i=new x.DeleteLayer(this,t);this.pushAction(new pt(i,s))}moveLayer(t,e){const s=this.layers.indexOf(t);if(-1==s)throw new Error("Specified layer is not found");this.moveLayerAt(s,e)}moveLayerAt(t,e){if(t>=this.layers.length||t<0)throw new RangeError("position is out of range");if(e>=this.layers.length||e<0)return;const s=new x.MoveLayer(this,e,t),i=new x.MoveLayer(this,t,e);this.pushAction(new pt(i,s))}moveLayerRelatively(t,e){const s=this.layers.indexOf(t);if(-1==s)throw new Error("Specified layer is not found");this.moveLayerAt(s,s+e)}changeLayerOpacity(t,e){if(e=i(e,0,1),t.opacity==e)return;const s=new x.ChangeLayerOpacity(this,t,t.opacity),n=new x.ChangeLayerOpacity(this,t,e);this.pushAction(new pt(n,s))}fill(t){const e=this.currentLayer,s=new x.DrawImage(this,e,e,0,0,e.width,e.height,0,0),i=new x.Fill(this,e,t);this.pushAction(new pt(i,s))}fillWithBackgroundColor(){this.fill(this.backgroundColor)}bucketFill(t,e,s,i,n){void 0!==e&&void 0!==s||(e=this._mouseX,s=this._mouseY);const r=gt.get().setSize(this.innerWidth,this.innerHeight),o=this.createBucketFillImageInto(r,e,s,i,n);if(void 0===o||o.isEmpty())return void gt.return(r);o.intersection4f(0,0,t.width,t.height);const a=new x.DrawImage(this,t,t,o.x,o.y,o.width,o.height,o.x,o.y),h=new x.DrawImage(this,t,r,o.x,o.y,o.width,o.height,o.x,o.y,!1);this.pushAction(new pt(h,a)),gt.return(r)}clear(){const t=this.currentLayer,e=new x.DrawImage(this,t,t,0,0,t.width,t.height,0,0),s=new x.Clear(this,t);this.pushAction(new pt(s,e))}drawPath(t,s){const i=this.currentLayer,n=e.intersection(function(t,s,i=0){if(0==t.length)return new e(0,0,0,0);const n=t[0];let r=n.x,o=n.x,a=n.y,h=n.y;for(let e=1;e<t.length;e++){const s=t[e];r=Math.min(r,s.x),o=Math.max(o,s.x),a=Math.min(a,s.y),h=Math.max(h,s.y)}const l=s/2;return r=r-l-i|0,o=Math.ceil(o+l+i),a=a-l-i|0,h=Math.ceil(h+l+i),new e(r,a,o-r,h-a)}(t,s.size,1),new e(0,0,this.documentWidth,this.documentHeight));let r;r=n.isEmpty()?new x.None(this):new x.DrawImage(this,i,i,n.x,n.y,n.width,n.height,n.x,n.y);const o=new x.DrawPath(this,i,s,this._strokeManager.path);this.pushAction(new pt(o,r))}flip(){const t=new x.Flip(this),e=new x.Flip(this);this.pushAction(new pt(e,t))}resize(t,e){if(e|=0,(t|=0)<1)throw new RangeError("width must be greater than 0");if(e<1)throw new RangeError("height must be greater than 0");let s;s=t>this.documentWidth&&e>this.documentHeight?new x.Resize(this,this.documentWidth,this.documentHeight):new x.UndoResize(this);const i=new x.Resize(this,t,e);this.pushAction(new pt(i,s))}selectNew(t){if(this.selectedRegion==t)return;const e=new x.SelectNew(this,this.selectedRegion),s=new x.SelectNew(this,t);this.pushAction(new pt(s,e))}selectAll(){const t=new F;t.setRect(new e(0,0,this.documentWidth,this.documentHeight)),this.selectNew(t)}selectMove(t,e){if(null==this.selectedRegion)return;if(null!==this._grabState)return void this.selectGrabMove(t,e);const s=new x.SelectMove(this,-t,-e),i=new x.SelectMove(this,t,e);this.pushAction(new pt(i,s))}putSelectedImageInto(t,e){const s=this.selectedRegion;if(null==s||s.isEmpty)return;const i=s.boudingRect();return t.setSize(i.width,i.height),t.context.drawImage(e.canvas,i.x,i.y,i.width,i.height,0,0,i.width,i.height),i}createBucketFillImageInto(t,s,i,n,o){if(void 0===t.context.filter)return this.createBucketFillImageInto_WebGL(t,s,i,n,o);s|=0,i|=0;const a=o?.tolerance||0,h=o?.closeGap||0,l=(o?.expand||0)+h/2,c=new e(0,0,0,0),u=this.getColorAt(s,i);if(void 0===u)return;const d=gt.get().setSize(this._offscreen.width,this._offscreen.height);this.clipBegin(d.context),d.context.drawImage(this._offscreen.canvas,0,0),this.clipEnd(d.context);const g=gt.get().setSize(this._offscreen.width,this._offscreen.height);{const t=new O;t.add("feFlood",{"flood-color":u}),t.add("feBlend",{mode:"difference",in2:"SourceGraphic",result:"diff"}),t.add("feBlend",{mode:"multiply",in:"diff",in2:"diff"});const e=65025,s=3+3*e*a/z.Bucket.toleranceMax;t.add("feColorMatrix",{type:"matrix",values:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e,e,e,0,-s]}),h>0&&t.add("feMorphology",{operator:"dilate",radius:h/2}),t.add("feColorMatrix",{type:"matrix",values:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1]}),mt(g.context,d.canvas,t.code)}{const t=ft(g.canvas,0,0,g.canvas.width,g.canvas.height).data,e=r(g.width,g.height,t,s,i),n=new ImageData(e.region,g.width,g.height);g.context.putImageData(n,0,0),c.set(e.rect).expand(Math.ceil(l))}{const e=new O;e.add("feFlood",{"flood-color":n}),e.add("feComposite",{in2:"SourceGraphic",operator:"in"}),l>0&&e.add("feMorphology",{operator:"dilate",radius:l}),mt(t.context,g.canvas,e.code)}return gt.return(g),gt.return(d),c}createBucketFillImageInto_WebGL(t,s,i,n,o){s|=0,i|=0;const a=o?.tolerance||0,h=o?.closeGap||0,l=(o?.expand||0)+h/2,c=new e(0,0,0,0),u=this.getColorAt(s,i);if(void 0===u)return;const d=gt.get().setSize(this._offscreen.width,this._offscreen.height);this.clipBegin(d.context),d.context.drawImage(this._offscreen.canvas,0,0),this.clipEnd(d.context);const g=gt.get().setSize(this._offscreen.width,this._offscreen.height);rt.drawImageWithFilters(g.context,d.canvas,[{filter:"color-mask",uniforms:{maskColor:[u.r,u.g,u.b],tolerance:a/z.Bucket.toleranceMax}},...this.genExpandFilters(h/2),{filter:"invert"}]);{const t=ft(g.canvas,0,0,g.canvas.width,g.canvas.height).data,e=r(g.width,g.height,t,s,i),n=new ImageData(e.region,g.width,g.height);g.context.putImageData(n,0,0),c.set(e.rect).expand(Math.ceil(l))}return rt.drawImageWithFilters(t.context,g.canvas,[...this.genExpandFilters(l),{filter:"paint",uniforms:{paintColor:[n.r,n.g,n.b]}}]),gt.return(g),gt.return(d),c}genExpandFilters(t){const e=[];for(;t>0;){const s=Math.min(t,5);e.push({filter:"expand",uniforms:{size:s}}),t-=s}return e}undo(){if(null!==this._grabState&&this.selectGrabFinish(),0==this._undoStack.length)return;const t=this._undoStack.pop();t.undo.exec(),this._redoStack.push(t),this.requestRender(),this.notify("update-history",this)}redo(){if(0==this._redoStack.length)return;const t=this._redoStack.pop();t.action.exec(),this._undoStack.push(t),this.requestRender(),this.notify("update-history",this)}pushAction(t){if(this._grabState&&this.selectGrabFinish(),t.action.exec(),0==this._redoStack.length){const e=this._undoStack.peek();if(void 0!==e){const s=t.mergeWith(e,this.strokeMergeTime);void 0!==s&&(this._undoStack.pop(),t=s)}}for(this._undoStack.push(t);this._undoStack.length>this.undoMax;)this._undoStack.shift().dispose();for(;this._redoStack.length>0;)this._redoStack.pop().dispose();this.notify("update-history",this),this.requestRender()}_grabState=null;get grabState(){return this._grabState}set grabState(t){this._grabState=t}selectGrab(){if(null==this.selectedRegion)return;const t=this.currentLayer;if(null!==this._grabState){if(this._grabState.layer==t)return;this.selectGrabFinish()}this.selectedRegion.normalize();const e=new x.GrabState(this,t),s=new x.SelectGrabStart(this,e),i=new x.SelectGrabCancel(this,e);this.pushAction(new pt(s,i))}selectGrabMove(t,e){if(null==this.selectedRegion)return;if(null==this._grabState&&(this.selectGrab(),null==this._grabState))throw new Error("Failed to grab");this._grabState.offsetX+=t,this._grabState.offsetY+=e,this.selectedRegion.offsetX=this._grabState.offsetX,this.selectedRegion.offsetY=this._grabState.offsetY;const s=this._grabState.layer,i=s.context,n=this.selectedRegion.boudingRect();s.clear(),i.drawImage(this._grabState.backupImage.canvas,0,0),i.clearRect(this._grabState.startX,this._grabState.startY,n.width,n.height),i.drawImage(this._grabState.image.canvas,n.x,n.y,n.width,n.height),s.notify("update",s),this.requestRender()}selectGrabFinish(){if(null==this._selectedRegion||null==this._grabState)return;const t=this._undoStack.peek();if(!(void 0!==t&&t.action instanceof x.SelectGrabStart&&t.undo instanceof x.SelectGrabCancel))return void console.warn("Latest action is not SelectGrabStart");const e=this._grabState,s=this._selectedRegion.boudingRect(),i=s.copy().intersection4f(0,0,e.layer.width,e.layer.height),n=new x.SelectMoveImage(this,e.layer,e.offsetX,e.offsetY),r=new x.Merge(new x.DrawImage(this,e.layer,e.backupImage,i.x,i.y,i.width,i.height,i.x,i.y),new x.DrawImage(this,e.layer,e.image,0,0,s.width,s.height,e.startX,e.startY),new x.SelectMove(this,-e.offsetX,-e.offsetY));t.action.dispose(),t.undo.dispose(),t.action=n,t.undo=r,this._grabState=null}getCanvasTopLeft(){return{left:this.width/2-this.documentWidth*this.scale/2-this._scrollX,top:this.height/2-this.documentHeight*this.scale/2-this._scrollY}}clientCoordToViewCoord(t,e){const s=this.canvas.getBoundingClientRect();return{x:t-=s.x,y:e-=s.y}}clientCoordToCanvasCoord(t,e){const s=this.clientCoordToViewCoord(t,e),i=this.getCanvasTopLeft();return{x:(s.x-i.left)/this.scale,y:(s.y-i.top)/this.scale}}viewCoordToCanvasCoord(t,e){const s=this.getCanvasTopLeft();return{x:(t-s.left)/this.scale,y:(e-s.top)/this.scale}}},wt=class{_element;constructor(){this._element=document.createElement("div"),this._element.className="dt_r_dt-selector"}select(t,e,s,i){null==this._element.parentElement&&document.body.appendChild(this._element),this._element.style.left=`${t}px`,this._element.style.top=`${e}px`,this._element.style.width=s-t+"px",this._element.style.height=i-e+"px"}close(){this._element.parentElement?.removeChild(this._element)}},bt=[new h(128,0,0),new h(139,22,21),new h(150,45,43),new h(161,67,64),new h(173,90,86),new h(184,112,107),new h(195,134,128),new h(207,157,150),new h(218,179,171),new h(229,202,193),new h(240,224,214),new h(255,255,238),new h(120,153,34),new h(0,64,224),new h(255,255,255),new h(0,0,0)],yt=class extends l{#K;#Z;#q;#J;#j;#$;#tt;#et=!1;#st=!1;constructor(t,e){super(),void 0===t&&(t=document.body);const s={},i=d('\n      <div class="dt_r_panel" style="display: none;" name="root" tabindex="-1">\n        <div name="titlebar" class="dt_r_titlebar">\n          <div name="titlebar-contents" class="dt_r_area-titlebar-contents"></div>\n          <div name="titlebar-title" class="dt_r_area-title"><span name="title"></span></div>\n          <div name="button-close" class="dt_r_area-button-close"><button data-on-click="onClickClose"><img src="[button-close.png]"></button></div>\n        </div>\n        <div name="contents" class="dt_r_contents"></div>\n      </div>\n    ',this,s);e&&i.classList.add(e),this.#K="",this.#Z=i,this.#q=s,this.#J=t=>{let e;e=!!function(t,e){for(;null!=t;){if(t==e)return!0;t=t.parentElement}return!1}(t.target,this.element),this.#st!=e&&(this.#st=e,this.#st?this.#it(t):this.#nt(t))},this.#j=!1,this.#$=!0,this.#tt=t,this.#rt()}get element(){return this.#Z}get title(){return this.#K}set title(t){this.#q.title.innerText=t,this.#K=t}get parent(){return this.#tt}get autoClose(){return this.#j}set autoClose(t){this.#j=t}get hasCloseButton(){return this.#$}set hasCloseButton(t){this.#$=t,this.#q["button-close"].style.display=t?"block":"none"}#ot=!0;get hasTitleBar(){return this.#$}set hasTitleBar(t){this.#ot=t,this.#q.titlebar.style.display=t?"block":"none"}get visible(){return this.#et}setContents(t){const e=this.#q.contents;for(;null!=e.firstChild;)e.removeChild(e.firstChild);e.appendChild(t)}setTitlebarContents(t){const e=this.#q["titlebar-contents"];for(;null!=e.firstChild;)e.removeChild(e.firstChild);e.appendChild(t)}open(t,e,s){const i=this.element;this.visible&&this.close(),void 0!==s&&(this.#tt=s),this.#et=!0,window.addEventListener("focusin",this.#J),this.#tt.appendChild(this.element),i.style.left=`${t}px`,i.style.top=`${e}px`,i.style.display="block",A(i),i.focus(),this.notify("open")}close(){this.visible&&(this.#et=!1,this.#tt.removeChild(this.element),this.element.style.display="none",window.removeEventListener("focusin",this.#J),this.#st=!1,this.notify("close"))}toggle(t,e,s){this.visible?this.close():this.open(t,e,s)}onBlur(t){this.notify("blur")}onClickClose(t){this.close()}#rt(){const t=this.#q,e=this.element;e.addEventListener("focus",(t=>{this.#st||(this.#st=!0,this.#it(t))}));let s=null;{let i={x:0,y:0},n={x:0,y:0};const r=t["titlebar-title"];r.addEventListener("pointerdown",(t=>{if(null!=s)return;s=t.pointerId,r.setPointerCapture(s);const o=e.getBoundingClientRect();i.x=o.x,i.y=o.y,n.x=t.clientX-o.x,n.y=t.clientY-o.y})),r.addEventListener("pointermove",(t=>{if(t.pointerId!=s)return;const i=t.clientX-n.x,r=t.clientY-n.y;e.style.left=`${i}px`,e.style.top=`${r}px`,A(e)})),r.addEventListener("pointerup",(t=>{s==t.pointerId&&(r.setPointerCapture(s),s=null)})),r.addEventListener("pointercancel",(t=>{null!=s&&(r.setPointerCapture(s),s=null)}))}}#it(t){this.element.setAttribute("data-focused","")}#nt(t){this.element.removeAttribute("data-focused"),this.onBlur(t),this.autoClose&&this.close()}},Ct=class extends yt{contents;#q;#at;#ht=0;#lt=1;#ct=100;#ut=1;#dt=null;#gt="readwrite";constructor(t,e=0){super(t,"dt_r_panel-slider"),this.#at=e,this.#q={},this.contents=d(`\n      <ul>\n        <li><span name="caption"></span><input type="range" name="slider" step="${this.#lt*this.#ut}" min="${this.#ht*this.#ut}" max="${this.#ct*this.#ut}"><input type="number" name="field" step="${this.#lt*this.#ut}" min="${this.#ht*this.#ut}" max="${this.#ct*this.#ut}"></li>\n      </ul>\n    `,this,this.#q),this.setContents(this.contents),this.hasTitleBar=!1,this.hasCloseButton=!1,this.autoClose=!0,this.init(),this.render()}render(){const t=this.#q.slider,e=this.#q.field,s=(this.#at*this.#ut|0).toString();t.value=s,e.value=s}init(){for(const t of["slider","field"]){const e=this.#q[t];e.addEventListener("input",(t=>{this.#at=parseInt(e.value)/this.scale,this.#at=i(this.#at,this.#ht,this.#ct),this.render()})),e.addEventListener("wheel",(t=>{t.preventDefault();const e=this.#at+this.#lt*(t.deltaY>0?-1:1);this.#At(e)}),{passive:!1}),e.addEventListener("change",(t=>{this.#At(parseInt(e.value)/this.scale)}))}}#At(t){t=i(t,this.#ht,this.#ct),this.#at=t,this.render(),this.notify("change",t),null!=this.#dt&&"readwrite"==this.#gt&&(this.#dt.value=this.#at)}bind(t,e="readwrite"){null!=this.#dt&&this.#dt.removeObserver(this),this.#dt=t,this.#gt=e,t&&(t.addObserver(this,"change",(t=>{this.value=t})),this.value=t.value)}set value(t){this.#at!=t&&(this.#at=t,this.render())}get value(){return this.#at}set scale(t){if(this.#ut!=t){this.#ut=t;for(const t of["slider","field"]){const e=this.#q[t];e.setAttribute("step",(this.#lt*this.#ut).toString()),e.setAttribute("min",(this.#ht*this.#ut).toString()),e.setAttribute("max",(this.#ct*this.#ut).toString())}this.render()}}get scale(){return this.#ut}get step(){return this.#lt}set step(t){this.#lt=t;const e=(t*this.#ut).toString();this.#q.slider.setAttribute("step",e),this.#q.field.setAttribute("step",e)}get min(){return this.#ht}set min(t){this.#ht=t;const e=(t*this.#ut).toString();this.#q.slider.setAttribute("min",e),this.#q.field.setAttribute("min",e)}get max(){return this.#ct}set max(t){this.#ct=t;const e=(t*this.#ut).toString();this.#q.slider.setAttribute("max",e),this.#q.field.setAttribute("max",e)}setRange(t,e){this.min=t,this.max=e}};class xt extends l{element;#h;#q;#pt;#tt;constructor(t,e){super(),this.#tt=t,this.#h=e,this.#q={},this.element=d('\n      <li class="dt_r_layer-item" data-on-click="onClick">\n        <div name="visibility" class="dt_r_block-visibility" data-on-click="onCliCKVisibility"></div>\n        <div class="dt_r_block-thumbnail">\n        <canvas name="canvas" class="dt_r_bg-transparent-s" width="48" height="32"></canvas>\n        </div>\n        <div class="dt_r_block-opacity">\n          <div class="dt_r_icon-opacity dt_r_bg-transparent-s" data-on-click="onClickOpacity"><div name="opacity-color" class="dt_r_opacity-color"></div></div>\n        </div>\n      </li>\n    ',this,this.#q);const s=this.#q.canvas.getContext("2d");this.#pt=s,s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="low",e.addObserver(this,"update",(()=>{this.#tt.visible&&this.requestRender()}));const i=this.#q.visibility;e.isVisible&&i.setAttribute("data-visible",""),e.observables.isVisible.addObserver(this,"change",(t=>{t?i.setAttribute("data-visible",""):i.removeAttribute("data-visible"),this.#tt.canvas.requestRender()})),e.observables.opacity.addObserver(this,"change",(t=>{this.updateOpacityIcon()})),this.updateOpacityIcon(),this.requestRender()}get layer(){return this.#h}#mt=this.render.bind(this);#vt=!1;requestRender(){this.#vt||(this.#vt=!0,window.requestAnimationFrame(this.#mt))}render(){this.#vt=!1;const t=this.#pt;t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high";const e=this.#h,s=function(t,e,s,i){let n,r;return s/i>1.5?(n=48,r=Math.ceil(48*i/s)):(n=Math.ceil(32*s/i),r=32),{width:n,height:r}}(0,0,e.width,e.height);t.canvas.width=s.width,t.canvas.height=s.height,t.clearRect(0,0,48,32),t.drawImage(e.canvas,0,0,e.width,e.height,0,0,s.width,s.height)}updateOpacityIcon(){this.#q["opacity-color"].style.backgroundColor=`rgba(48, 23, 23, ${this.#h.opacity})`}onClick(t){this.#tt.canvas.selectLayer(this.#h)}onCliCKVisibility(t){t.stopPropagation(),this.#h.isVisible=!this.#h.isVisible}onClickOpacity(t){t.stopPropagation();const e=this.#tt.opacitySlider;e.close(),e.bind(this.#h.observables.opacity,"read"),e.addObserver(this,"change",(t=>{this.#tt.canvas.changeLayerOpacity(this.#h,t)})),e.addObserver(this,"close",(()=>{e.removeObserver(this)})),e.open(t.clientX,t.clientY)}dispose(){this.#h.removeObserver(this)}}const kt=class extends yt{#q={};#ft=[];#_t;#wt;opacitySlider;constructor(t,e){super(t,"dt_r_panel-layer"),this.opacitySlider=new Ct(t,0),this.opacitySlider.setRange(0,1),this.opacitySlider.step=.01,this.opacitySlider.scale=100,this.opacitySlider.addObserver(this,"change",(()=>{this.#wt.requestRender()})),this.#_t=d('\n      <div name="contents">\n        <div class="dt_r_area-buttons">\n          <button name="button-new" data-on-click="onClickNew"><img src="[icon-layer-new.png]"></button>\n          <button name="button-up" data-on-click="onClickUp"><img src="[icon-layer-up.png]"></button>\n          <button name="button-down" data-on-click="onClickDown"><img src="[icon-layer-down.png]"></button>\n          <div class="dt_r_space"></div>\n          <button name="button-delete" data-on-click="onClickDelete"><img src="[icon-layer-delete.png]"></button>\n        </div>\n        <div class="dt_r_area-layers">\n          <ul name="layers" class="dt_r_layers">\n          </ul>\n        </div>\n      </div>\n    ',this,this.#q),this.setContents(this.#_t),this.title="",this.#wt=e,this.bindCanvas(e)}get canvas(){return this.#wt}bindCanvas(t){this.#wt=t,this.#ft.length=0;const e=t.currentLayer,s=this.#q.layers;for(let i of t.layers){const t=new xt(this,i);this.#ft.push(t),i==e&&t.element.setAttribute("data-active",""),s.appendChild(t.element)}t.addObserver(this,"add-layer",(t=>{const e=new xt(this,t.layer);this.#ft.splice(t.position,0,e);const i=s.children[t.position];s.insertBefore(e.element,i||null)})),t.addObserver(this,"delete-layer",(t=>{this.#q.layers;for(let e of this.#ft)e.layer==t.layer&&e.element.parentElement?.removeChild(e.element);this.#ft.splice(t.position,1)})),t.addObserver(this,"move-layer",(t=>{const e=this.#q.layers,s=this.#ft[t.from];this.#ft.splice(t.from,1);const i=this.#ft[t.to];this.#ft.splice(t.to,0,s),e.insertBefore(s.element,i?i.element:null)})),t.addObserver(this,"change-current-layer",(t=>{for(let e of this.#ft)e.layer==t.layer?e.element.setAttribute("data-active",""):e.element.removeAttribute("data-active")})),t.addObserver(this,"change-document",(t=>{const s=this.#q.layers;s.innerHTML="",this.#ft.length=0;for(let i of t.layers){const t=new xt(this,i);this.#ft.push(t),i==e&&t.element.setAttribute("data-active",""),s.appendChild(t.element)}}))}open(t,e){super.open(t,e);for(let t of this.#ft)t.requestRender()}onClickNew(t){this.#wt.newLayer(this.#wt.currentLayerPosition+1)}onClickDelete(t){this.#wt.deleteLayer(this.#wt.currentLayer)}onClickUp(t){this.#wt.moveLayerRelatively(this.#wt.currentLayer,1)}onClickDown(t){this.#wt.moveLayerRelatively(this.#wt.currentLayer,-1)}},St=[{name:"",width:344,height:135},{name:"",width:400,height:400},{name:"",width:135,height:344}],Et=class extends yt{contents;canvas;#q;constructor(t,e){super(t,"dt_r_panel-resize"),this.#q={},this.contents=d('\n      <div>\n        <section class="dt_r_area_input">\n          <div class="dt_r_row">\n            <label>:</label><input type="number" name="input-width" min="1" data-on-change="onChangeSizeField">\n          </div>\n          <div class="dt_r_row">\n            <label>:</label><input type="number" name="input-height" min="1" data-on-change="onChangeSizeField">\n          </div>\n        </section>\n        <section class="dt_r_area_presets" name="list-presets">\n        </section>\n      </div>\n    ',this,this.#q),this.setContents(this.contents),this.canvas=e,this.hasTitleBar=!1,this.hasCloseButton=!1,this.autoClose=!0,this.renderPresets(St);const s=this.#q["input-width"],i=this.#q["input-height"];e.addObserver(this,"change-document-size",(()=>{s.value=e.documentWidth+"",i.value=e.documentHeight+""})),this.renderCurrentSize()}renderCurrentSize(){const t=this.#q["input-width"],e=this.#q["input-height"];t.value=this.canvas.documentWidth+"",e.value=this.canvas.documentHeight+""}onChangeSizeField(){const t=this.#q["input-width"],e=this.#q["input-height"],s=parseInt(t.value),i=parseInt(e.value);s<=0||i<=0||isNaN(s)||isNaN(i)?this.renderCurrentSize():this.canvas.resize(s,i)}addPreset(t){const e={},s=d(`\n      <div class="dt_r_preset">\n        <div class="dt_r_size_preview">\n          <div class="dt_r_box" name="box"></div>\n        </div>\n        <div class="dt_r_width">${t.width}</div>\n        <div class="dt_r_height">${t.height}</div>\n      </div>\n    `,this,e),i=function(t,e,s,i){const n=80/s,r=80/i,o=Math.min(n,r);return{width:s*o,height:i*o}}(0,0,t.width,t.height);e.box.style.width=`${i.width}px`,e.box.style.height=`${i.height}px`,s.addEventListener("click",(e=>{this.canvas.resize(t.width,t.height),this.close()})),this.#q["list-presets"].appendChild(s)}renderPresets(t){for(const e of t)this.addPreset(e)}};class Rt extends l{element;#gt="read";#bt=null;#at;constructor(t,e){super(),this.element=document.createElement("li"),this.#at=e}bind(t,e="readwrite"){return this.#bt&&this.#bt.removeObserver(this),this.#bt=t,this.#gt=e,null==this.#bt||(t.addObserver(this,"change",this.onReceiveValue),this.value=t.value),this}get value(){return this.#at}set value(t){this.#at!=t&&(this.#at=t,null!=this.#bt&&"readwrite"==this.#gt&&(this.#bt.value=t),this.notify("change",t))}onReceiveValue(t){}onChange(){this.notify}}class Bt extends Rt{#_t;#q={};#ht;#ct;#lt;#yt;constructor(t,e,s,i,n=1){super(t,e),this.#ht=s,this.#ct=i,this.#lt=n,this.#yt=e,this.#_t=d(`\n      <div class="dt_r_item-number">\n        <span name="caption">${t}</span>\n        <div>\n          <input type="range" name="slider" step="${n}" min="${s}" max="${i}">\n          <input type="number" name="field" step="${n}" min="${s}" max="${i}">\n        </div>\n      </div>\n    `,this,this.#q),this.element.appendChild(this.#_t),this.#rt(),this.render()}render(){const t=this.#q.slider,e=this.#q.field,s=(0|this.#yt).toString();t.value=s,e.value=s}#rt(){const t=this.#q.slider,e=this.#q.field;for(let s of[t,e])s.addEventListener("input",(t=>{const e=parseInt(s.value);this.#yt=i(e,this.#ht,this.#ct),this.render()})),s.addEventListener("wheel",(t=>{t.preventDefault();let e=this.value+this.#lt*(t.deltaY>0?-1:1);this.value=i(e,this.#ht,this.#ct)}),{passive:!1}),s.addEventListener("change",(t=>{let e=parseInt(s.value);this.value=i(e,this.#ht,this.#ct)}));this.addObserver(this,"change",(t=>{this.#yt=t,this.render()}))}}const Tt=class extends yt{contents;#q;constructor(t,e=0){super(t,"dt_r_panel-properties"),this.#q={},this.contents=d('\n      <ul>\n        <li class="dt_r_preview" style="display: none;" name="preview"></li>\n      </ul>\n    ',this,this.#q),this.setContents(this.contents),this.hasTitleBar=!1,this.hasCloseButton=!1,this.autoClose=!0}addItem(t){return this.contents.appendChild(t.element),t}showPreview(){this.#q.preview.style.display="block"}},Mt=class extends Tt{constructor(t,e){super(t),this.addItem(new Bt("",0,0,20).bind(e.obaservables.closeGap)),this.addItem(new Bt("",0,0,20).bind(e.obaservables.tolerance)),this.addItem(new Bt("",0,0,10).bind(e.obaservables.expand))}},Dt=class extends l{},Ft=class extends Dt{#Z;#pt;#o=new h(255,0,0);#T;#B;#d=0;#g=0;#Ct=null;observable;constructor(){super(),this.observable={hue:new E(0)},this.#B=112,this.#T=112,this.#Z=d(`<canvas class="dt_r_color-picker-area" width="${this.#B}" height="${this.#T}">`);const t=this.#Z.getContext("2d");if(null==t)throw new Error("Failed to create RenderingContext2D");this.#pt=t,this.#rt(),this.render()}get hue(){return this.observable.hue.value}set hue(t){this.hue!=t&&(t=i(t,0,360),this.observable.hue.value=t)}get saturation(){return this.#d}get value(){return this.#g}get element(){return this.#Z}get width(){return this.#B}get height(){return this.#T}setSize(t,e){this.#B=t,this.#T=e,this.#Z.width=t,this.#Z.height=e,this.requestRender()}#rt(){const t=this.#Z;t.addEventListener("pointerdown",(e=>{e.isPrimary&&(t.setPointerCapture(e.pointerId),this.#d=i(e.offsetX/this.width,0,1),this.#g=i(1-e.offsetY/this.#T,0,1),this.onChange(),this.requestRender())})),t.addEventListener("pointermove",(e=>{t.hasPointerCapture(e.pointerId)&&(this.#d=i(e.offsetX/this.width,0,1),this.#g=i(1-e.offsetY/this.#T,0,1),this.onChange(),this.requestRender())})),this.observable.hue.addObserver(this,"change",(t=>{this.requestRender()}))}setRgbColor(t){this.#o.set(t);const e=this.#o.hsv();0!=e.s&&(this.hue=e.h),this.#d=e.s,this.#g=e.v}#vt=!1;requestRender(){this.#vt||(this.#vt=!0,requestAnimationFrame(this.render.bind(this)))}render(){this.#vt=!1,this.#o.hsv();const t=this.#pt,e=this.width,s=this.height,i=h.fromHsv(this.hue,1,1);t.fillStyle="#FFF",t.fillRect(0,0,e,s);const n=t.createLinearGradient(0,0,e,0);n.addColorStop(0,"#FFF"),n.addColorStop(1,i.css()),t.fillStyle=n,t.fillRect(0,0,e,s);const r=t.createLinearGradient(0,0,0,s);r.addColorStop(0,"rgba(0, 0, 0, 0)"),r.addColorStop(1,"#000"),t.fillStyle=r,t.fillRect(0,0,e,s);const o=this.width*this.#d,a=this.height*(1-this.#g);t.lineWidth=1,t.strokeStyle="#000",t.beginPath(),t.arc(o,a,3.5,0,2*Math.PI),t.stroke(),t.strokeStyle="#FFF",t.beginPath(),t.arc(o,a,2.5,0,2*Math.PI),t.stroke()}bind(t){null!=this.#Ct&&this.#Ct.removeObserver(this),this.#Ct=t,null!=t&&(t.addObserver(this,"change",(t=>{t.equals(this.#o)||(this.setRgbColor(t),this.requestRender())})),this.setRgbColor(t.value))}onChange(){this.#o.setHsv(this.hue,this.#d,this.#g),null!=this.#Ct&&(this.#Ct.value=this.#o),this.notify("change",this.#o)}},It=class extends Dt{#Z;#pt;#xt;#T;#B;#Ct=null;constructor(){super(),this.#xt=0,this.#B=112,this.#T=112,this.#Z=d(`<canvas class="dt_r_colorbar" width="${this.#B}" height="${this.#T}">`);const t=this.#Z.getContext("2d");if(null==t)throw new Error("Failed to create RenderingContext2D");this.#pt=t,this.#rt(),this.render()}get element(){return this.#Z}get width(){return this.#B}get height(){return this.#T}setSize(t,e){this.#B=t,this.#T=e,this.#Z.width=t,this.#Z.height=e,this.requestRender()}get hue(){return this.#xt}set hue(t){this.#xt!=t&&(this.#xt=i(t,0,360),this.render())}#rt(){const t=this.#Z;t.addEventListener("pointerdown",(e=>{e.isPrimary&&(t.setPointerCapture(e.pointerId),this.#xt=i(360*e.offsetY/this.#T,0,360),this.onChange(),this.requestRender())})),t.addEventListener("pointermove",(e=>{t.hasPointerCapture(e.pointerId)&&(this.#xt=i(360*e.offsetY/this.#T,0,360),this.onChange(),this.requestRender())}))}setRgbColor(t){const e=t.hsv();0!=e.s&&(this.#xt=e.h)}#vt=!1;requestRender(){this.#vt||(this.#vt=!0,requestAnimationFrame(this.render.bind(this)))}render(){this.#vt=!1;const t=this.#pt,e=t.createLinearGradient(0,0,0,this.#T);for(let t=0;t<=360;t+=60)e.addColorStop(t/360,`hsl(${t}, 100%, 50%)`);t.fillStyle=e,t.fillRect(0,0,this.#B,this.#T);const s=this.#xt/360*this.height|0;t.lineWidth=1,t.strokeStyle="black",t.strokeRect(.5,s-3.5,this.width-1,7),t.strokeStyle="white",t.strokeRect(1.5,s-2.5,this.width-3,5)}bind(t){null!=this.#Ct&&this.#Ct.removeObserver(this),this.#Ct=t,null!=t&&(t.addObserver(this,"change",(t=>{this.#xt!=t&&(this.#xt=t,this.requestRender())})),this.#xt=t.value)}onChange(){null!=this.#Ct&&(this.#Ct.value=this.#xt),this.notify("change",this.hue)}};function Lt(t,e,s){let i=(0|t).toString();for(;i.length<s;)i=e+i;return i}const zt=class extends yt{contents;_outlets;_color;_picker;_huebar;_boundColor=null;_palette;_dragging=!1;constructor(t,e=255,s=255,i=255){super(t,"dt_r_panel-color"),this._color=new h(255,255,255),this._outlets={},this.contents=d('\n      <div class="dt_r_wrap">\n        <div class="dt_r_area-palette">\n          <ul name="colors" class="dt_r_colors">\n          </ul>\n        </div>\n        <div class="dt_r_area-picker">\n          <ul>\n            <li><div class="dt_r_preview" name="preview" draggable="true" data-on-drag="onDragPreview" data-on-dragstart="onDragPreviewStart" data-on-dragend="onDragPreviewEnd"></div></li>\n            <li name="picker">\n            </li>\n          </ul>\n        </div>\n      </div>\n    ',this,this._outlets),this._picker=new Ft,this._picker.setSize(122,76),this._picker.addObserver(this,"change",(t=>{this.change(t)})),this._outlets.picker.appendChild(this._picker.element),this._huebar=new It,this._huebar.setSize(24,76),this._huebar.bind(this._picker.observable.hue),this._huebar.addObserver(this,"change",(t=>{this._picker.onChange()})),this._outlets.picker.appendChild(this._huebar.element),this.setContents(this.contents),this.hasTitleBar=!1,this.hasCloseButton=!1,this.autoClose=!0,this._palette=[];const n=this._outlets.colors;for(let t=0;t<4;t++)for(let t=0;t<4;t++){const t=document.createElement("li");t.style.backgroundColor="#FFFFFF",n.appendChild(t);const e=new h(255,255,255),s={element:t,color:e};this._palette.push(s),t.onclick=()=>{this.change(e)},t.addEventListener("dragover",(t=>{t.preventDefault()}),!1),t.addEventListener("drop",(t=>{t.preventDefault(),this._dragging&&(s.color.set(this.color),s.element.style.backgroundColor=s.color.css(),this.render())}))}this.init(),this.render()}bind(t){null!=this._boundColor&&this.removeObserver(this),this._boundColor=t,this._picker.bind(t),null!=t&&(t.addObserver(this,"change",(t=>{this._color.set(t),this.render()})),this._color.set(t.value),this.render())}#kt=[];render(){const t=this._outlets.preview;t.style.backgroundColor=this._color.css();const e=this._picker.saturation,s=this._picker.value;if(t.style.color=s>.5&&e<.5?"black":"white",t.innerText=function(t){return`rgb(${Lt(t.r," ",3)},${Lt(t.g," ",3)},${Lt(t.b," ",3)})`}(this._color),this.#kt.length>0){for(let t=0;t<this.#kt.length;t++)this.#kt[t].element.classList.remove("dt_r_selected");this.#kt.length=0}for(let t=0;t<this._palette.length;t++){const e=this._palette[t];this._color.equals(e.color)&&(e.element.classList.add("dt_r_selected"),this.#kt.push(e))}}init(){}change(t){this._color.equals(t)||(this.set(t),null!=this._boundColor&&(this._boundColor.value=t),this.notify("change",t))}set(t){this._color.equals(t)||(this._color.set(t),this.render())}get color(){return this._color}setPalette(t){const e=Math.min(this._palette.length,t.length);for(let s=0;s<e;s++){const e=this._palette[s],i=t[s];e.color.set(i),e.element.style.backgroundColor=i.css()}}onDragPreview(t){}onDragPreviewStart(t){this._dragging=!0,t.stopPropagation()}onDragPreviewEnd(t){this._dragging=!1,t.stopPropagation()}},Ot=class extends Tt{constructor(t,e){super(t),this.addItem(new Bt("",20,1,100).bind(e.observables.undoMax)),this.addItem(new Bt("",0,0,500).bind(e.observables.strokeMergeTime))}},Yt=class extends yt{contents;_outlets;_value;constructor(t,e){super(t,"dt_r_size-selector"),this._value=e,this._outlets={},this.contents=d('\n      <ul>\n        <li class="dt_r_row-preview"><div class="dt_r_preview" name="preview"></div></li>\n        <li><span>: </span><input type="range" name="slider" min="1" max="20"><input type="number" name="field" min="1" max="20"></li>\n      </ul>\n    ',this,this._outlets),this.setContents(this.contents),this.hasTitleBar=!1,this.hasCloseButton=!1,this.autoClose=!0,this.init(),this.render()}render(){const t=this._outlets.slider,e=this._outlets.field,s=this._value.toString();t.value=s,e.value=s,this._outlets.preview.style.height=`${this._value}px`}init(){for(const t of["slider","field"]){const e=this._outlets[t];e.addEventListener("input",(t=>{this._value=parseInt(e.value),this._value=i(this._value,1,20),this.render()})),e.addEventListener("wheel",(t=>{t.preventDefault(),this._value+=t.deltaY>0?-1:1,this._value=i(this._value,1,20),this.render(),this.notify("change",this._value)}),{passive:!1}),e.addEventListener("change",(t=>{this._value=parseInt(e.value),this._value=i(this._value,1,20),this.render(),this.notify("change",this._value)}))}}set value(t){this._value!=t&&(this._value=t,this.render())}get value(){return this._value}};class Ut{set(t,e){const s={};return s[t]=e,chrome.storage.local.set(s)}async get(t){const e=await chrome.storage.local.get(t);return void 0===e[t]?null:e[t]}remove(t){return chrome.storage.local.remove(t)}}class Xt{async set(t,e){window.localStorage.setItem(t,JSON.stringify(e))}async get(t){const e=window.localStorage.getItem(t);if(null==e)return null;try{return JSON.parse(e)}catch{return e}}async remove(t){window.localStorage.removeItem(t)}}var Pt;!function(t){t.local=n?new Ut:new Xt}(Pt||(Pt={}));const Wt=Pt;function Gt(t,e,s="data"){const i=function(t){switch(typeof t){case"string":return"string";case"number":return"number";case"boolean":return"boolean"}return t instanceof Array?"array":null==t?"null":"object"}(t);if(e instanceof Array){if("array"!==i)throw new Error(`${s} must be array`);for(let i=0;i<t.length;i++){const n=s+"["+i+"]";Gt(t[i],e[0],n)}return t}if("object"==typeof e){if("object"!==i)throw new Error(`${s} must be object`);for(const i in e){const n=s+"."+i;Gt(t[i],e[i],n)}return t}if("null"==e){if(null!==t)throw new Error(`${s} must be null`);return t}if(e.startsWith("number")){const i=function(t){const e=t.indexOf("?")>=0;let s,i,n;{const e=t.match(/\|>([\d\.]+)/);s=e?Number(e[1]):void 0}{const e=t.match(/\|<([\d\.]+)/);i=e?Number(e[1]):void 0}{const e=t.match(/\|=([\d\.]+)/);n=e?Number(e[1]):void 0}return{nullable:e,min:s,max:i,init:n}}(e);if(void 0===t)return void 0!==i.init?i.init:(i.nullable,t);if("number"!=typeof t)throw new Error(`${s} must be a number`);return void 0!==i.min&&t<i.min?i.min:void 0!==i.max&&t>i.max?i.max:t}if(e!==typeof t)throw new Error(`${s} must be a ${e}`);return t}var Vt;!function(t){t.match=function(e){for(let s of t.shortcuts)if(s.key==e.key&&(!0===s.ctrl||"Control"==s.key)==e.ctrlKey&&(!0===s.alt||"Alt"==s.key)==e.altKey&&(!0===s.shift||"Shift"==s.key)==e.shiftKey&&(!e.repeat||!1!==s.press))return s;return null},t.shortcuts=[{name:"undo",ctrl:!0,key:"z"},{name:"redo",ctrl:!0,key:"y"},{name:"copy",ctrl:!0,key:"c",press:!1},{name:"select-all",ctrl:!0,key:"a",press:!1},{name:"deselect",ctrl:!0,key:"d",press:!1},{name:"clear",key:"Backspace",press:!1},{name:"size-change",ctrl:!0,key:"Alt"},{name:"scroll",key:" ",mode:"Temporary",press:!1},{name:"spoit",key:"Alt",mode:"Temporary",press:!1},{name:"pencil",key:"n",mode:"PressTemp",press:!1},{name:"eraser",key:"e",mode:"PressTemp",press:!1},{name:"select",key:"m",mode:"PressTemp",press:!1},{name:"bucket",key:"g",mode:"PressTemp",press:!1},{name:"grab-up",ctrl:!0,key:"ArrowUp"},{name:"grab-down",ctrl:!0,key:"ArrowDown"},{name:"grab-left",ctrl:!0,key:"ArrowLeft"},{name:"grab-right",ctrl:!0,key:"ArrowRight"},{name:"move-up",key:"ArrowUp"},{name:"move-down",key:"ArrowDown"},{name:"move-left",key:"ArrowLeft"},{name:"move-right",key:"ArrowRight"},{name:"move-fast-up",shift:!0,key:"ArrowUp"},{name:"move-fast-down",shift:!0,key:"ArrowDown"},{name:"move-fast-left",shift:!0,key:"ArrowLeft"},{name:"move-fast-right",shift:!0,key:"ArrowRight"},{name:"zoom-in",ctrl:!0,key:"WheelUp"},{name:"zoom-out",ctrl:!0,key:"WheelDown"},{name:"pensize-down",key:"["},{name:"pensize-up",key:"]"}]}(Vt||(Vt={}));const Qt=Vt;class Nt extends l{observables;constructor(t){super(),this.observables={undoMax:new E(t.undoMax),strokeMergeTime:new E(t.strokeMergeTime)};for(const t in this.observables)this.observables[t].addObserver(this,"change",(t=>{this.notify("change",this)}))}get undoMax(){return this.observables.undoMax.value}get strokeMergeTime(){return this.observables.strokeMergeTime.value}sync(){for(const t in this.observables)this.observables[t].sync()}serialize(){return{undoMax:this.undoMax,strokeMergeTime:this.strokeMergeTime}}static async load(t){try{const e=await Wt.local.get(t);return null==e?null:(Gt(e,Nt.structure),e)}catch(t){console.warn("[Discord Tegaki]Failed to load settings"),console.warn(t)}return null}}!function(t){t.initialSettings={undoMax:20,strokeMergeTime:150},t.structure={undoMax:"number?|>0|<200|=20",strokeMergeTime:"number?|>0|<500|=150"}}(Nt||(Nt={}));const Ht=Nt,Kt=428,Zt=203,qt={width:344,height:135,penSize:4,eraserSize:4,foreColor:new h(128,0,0),backgroundColor:new h(240,224,214)};class Jt{tool=new E(z.none);backgroundColor=new R(240,224,214)}const jt=["pen","eraser","spoit","bucket","select"];class $t extends Dt{#Z;#pt;#at=1;constructor(){super();const t=function(t,e){const s=document.createElement("canvas");s.width=24,s.height=24;const i=s.getContext("2d");if(null==i)throw new Error("Failed to get RenderingContext2D");return{canvas:s,context:i}}();this.#Z=t.canvas,this.#pt=t.context}get element(){return this.#Z}set value(t){this.#at!=t&&(this.#at=t,this.render())}render(){const t=this.#pt;if(t.clearRect(0,0,24,24),this.#at<=0)return;t.fillStyle="#300";const e=this.#at%2==0?0:.5;t.fillRect(0,12-this.#at/2+e,24,this.#at),t.font="14px caption";const s=this.#at.toString(),i=t.measureText(s);t.lineWidth=2,t.strokeStyle="#300",t.fillStyle="white",t.textBaseline="middle",t.strokeText(s,12-i.width/2,12),t.fillText(s,12-i.width/2,12)}}class te{_width;_height;_outlets;_canvas;_state;_settings;_panelColor;_palettePenSize;_panelLayer;_panelBucket;_panelSettings;_panelResize;_lineSizeDisplay=new $t;_root;_window;_shortcutDownTime=new Map;_toolPen=new z.Brush("pen",qt.penSize);_toolEraser=new z.Brush("eraser",qt.eraserSize);_toolSpoit=new z.Spoit;_toolBucket=new z.Bucket;_toolSelect=new z.Select;_toolScroll=new z.Scroll;_previousTool=z.none;_nextPreviousTool=z.none;_autoSaveInterval=5;_autoSaveTimer=0;_copyOverride;constructor(t){if(this._settings=new Ht(t||Ht.initialSettings),this._state=new Jt,this._state.tool.value=this._toolPen,this._outlets={},this._root=d('<div class="dt_r_t_doc dt_r_disco-tegaki dt_r_root" data-on-keydown="onKeydown" data-on-keypress="onKeyPress" data-on-keyup="onKeyup" data-on-blur="onBlur">\n<div class="dt_r_window" name="window" tabindex="-1">\n  <div class="dt_r_inner">\n    <section class="dt_r_area-head" name="titlebar">\n      <div class="dt_r_tools">\n        <button name="tool-new" data-on-click="onClickNew"><img src="[tool-new.png]"></button>\n        <button name="tool-save" data-on-click="onClickSave"><img src="[tool-save.png]"></button>\n        <button name="tool-resize" data-on-click="onClickResize"><img src="[icon-resize.png]"></button>\n        <button name="icon-settings" data-on-click="onClickSettings"><img src="[icon-settings.png]"></button>\n        <div class="dt_r_separator"><img src="[separator.png]"></div>\n\n        <button name="tool-zoom-in" data-on-click="onClickZoomIn"><img src="[tool-zoom-in.png]"></button>\n        <button name="tool-zoom-out" data-on-click="onClickZoomOut"><img src="[tool-zoom-out.png]"></button>\n        <button name="tool-flip" data-on-click="onClickFlip"><img src="[tool-flip.png]"></button>\n        <div class="dt_r_separator"><img src="[separator.png]"></div>\n        \n        <button name="tool-clear" data-on-click="onClickClear"><img src="[tool-clear.png]"></button>\n        <div class="dt_r_separator"><img src="[separator.png]"></div>\n        \n        <button name="tool-layer" data-on-click="onClickLayer"><img src="[tool-layer.png]"></button>\n      </div>\n      <div name="label-title" class="dt_r_title"></div>\n      <button name="button-close" class="dt_r_button-close" data-on-click="onClickClose"></button>\n    </section>\n    <section class="dt_r_area-main">\n      <div class="dt_r_area-draw" name="area-draw" data-on-wheel="onWheelOnCanvas">\n    </div>\n      <div class="dt_r_area-tools">\n        \n        <div class="dt_r_color-cell"  name="backgroundColor" data-on-click="onClickBackgroundColor"></div>\n        <div class="dt_r_tools">\n          <button name="tool-pen" data-on-pointerdown="onClickPen"><img name="icon-pen" src="[tool-pen.png]"></button>\n          <button name="tool-fore-color" data-on-pointerdown="onClickForeColor"><div class="dt_r_color-cell" name="foreColor"></div></button>\n\n          <button name="tool-eraser" data-on-pointerdown="onClickEraser"><img name="icon-eraser" src="[tool-eraser.png]"></button>\n          <button name="tool-background-color" data-on-pointerdown="onClickBackgroundColor"><div class="dt_r_color-cell" name="backgroundColor"></div></button>\n\n          <button name="tool-select" data-on-pointerdown="onClickSelect"><img name="icon-select" src="[tool-select.png]"></button>\n          <button name="tool-size" data-on-pointerdown="onClickPenSize"></button>\n\n          <button name="tool-spoit" data-on-pointerdown="onClickSpoit"><img name="icon-spoit" src="[tool-spoit.png]"></button>\n          <button name="tool-bucket" data-on-pointerdown="onClickBucket"><img name="icon-bucket" src="[tool-bucket.png]"></button>\n\n          <div class="dt_r_spacer"></div>\n\n          <button name="tool-undo" data-on-click="onClickUndo"><img src="[tool-undo.png]"></button>\n          <button name="tool-redo" data-on-click="onClickRedo"><img src="[tool-redo.png]"></button>\n        </div>\n      </div>\n    </section>\n    <section class="dt_r_area-bottom">\n      <button class="dt_r_button-copy" name="button-copy" data-on-click="onClickCopy"></button>\n      <div class="dt_r_status" name="status"></div>\n    </section>\n    <div name="resize" class="dt_r_area-resize"><img src="[resize.png]"></div>\n  </div>\n</div>\n\n</div>',this,this._outlets),this._window=this._outlets.window,this._width=Kt,this._height=Zt,this._updateWindowSize(),this._canvas=new _t({width:344,height:135,foreColor:new h(128,0,0),backgroundColor:new h(240,224,214)}),this._outlets["area-draw"].appendChild(this._canvas.element),n&&(d('<div class="dt_r_t_doc dt_r_disco-tegaki dt_r_button-open" name="button-open"><button data-on-click="onClickOpen"></button></div>',this,this._outlets),document.body.appendChild(this._outlets["button-open"])),void 0===this._canvas.context.filter)try{rt.init()}catch{this._outlets["tool-bucket"].style.visibility="hidden"}document.body.appendChild(this._root),this._outlets["tool-size"].appendChild(this._lineSizeDisplay.element),this._panelColor=new zt(this._root),this._panelColor.setPalette(bt),this._palettePenSize=new Yt(this._root,1),this._panelLayer=new kt(this._root,this._canvas),this._panelBucket=new Mt(this._root,this._toolBucket),this._panelSettings=new Ot(this._root,this._settings),this._panelResize=new Et(this._root,this._canvas),this.resetStatus(),this.init(),this.bind()}get width(){return this._width}get height(){return this._height}setWindowSize(t,e){this._width=Math.max(0|t,Kt),this._height=Math.max(0|e,Zt),this._updateWindowSize()}_updateWindowSize(){this._window.style.width=`${this.width}px`,this._window.style.height=`${this.height}px`,this.adjustWindow()}get isVisible(){return"block"==this._window.style.display}init(){const t=this._window;this._outlets["label-title"].innerText="v1.4.4",new ResizeObserver((t=>this.onResize(t[0].contentRect.width,t[0].contentRect.height))).observe(this._outlets["area-draw"]);{let e={x:0,y:0},s={x:0,y:0};const i=this._outlets.titlebar;ht.listen(i,"drag-start",(i=>{const n=t.getBoundingClientRect();e.x=n.x,e.y=n.y,s.x=i.pointers[0].startClientX-n.x,s.y=i.pointers[0].startClientY-n.y})),ht.listen(i,"drag-move",(e=>{t.getBoundingClientRect();const i=e.pointers[0].clientX-s.x,n=e.pointers[0].clientY-s.y;t.style.left=`${i}px`,t.style.top=`${n}px`,this.adjustWindow()}))}{const e=this._outlets.resize;let s=null,n=t.getBoundingClientRect(),r={x:0,y:0};ht.listen(e,"drag-start",(e=>{n=t.getBoundingClientRect(),r.x=e.pointers[0].startClientX-n.right,r.y=e.pointers[0].startClientY-n.bottom,s=new wt,s.select(n.left,n.top,n.right,n.bottom)})),ht.listen(e,"drag-move",(t=>{const e=i(t.pointers[0].clientX-r.x,0,document.documentElement.clientWidth),o=i(t.pointers[0].clientY-r.y,0,document.documentElement.clientHeight),a=e-n.right,h=o-n.bottom,l=Math.max(n.right+a-n.x,Kt),c=Math.max(n.bottom+h-n.y,Zt);s?.select(n.x,n.y,n.x+l,n.y+c)})),ht.listen(e,"drag-end",(t=>{const e=i(t.pointers[0].clientX-r.x,0,document.documentElement.clientWidth),o=i(t.pointers[0].clientY-r.y,0,document.documentElement.clientHeight),a=e-n.right,h=o-n.bottom;this.setWindowSize(this.width+a,this.height+h),s?.close()})),e.addEventListener("pointercancel",(t=>{this.resetStatus(),s?.close()}))}window.addEventListener("resize",(t=>{this.adjustWindow()})),window.addEventListener("blur",(t=>{this.onBlur(t)})),n||window.addEventListener("focus",(t=>{this._root.focus()})),this._root.addEventListener("wheel",(t=>{}),{passive:!1}),this._root.addEventListener("dragstart",(t=>{t.preventDefault()})),this._root.addEventListener("touchstart",(t=>{t.touches&&t.touches.length>1&&t.preventDefault()}),{passive:!1}),this._root.addEventListener("touchmove",(t=>{t.touches&&t.touches.length>1&&t.preventDefault()}),{passive:!1})}onResize(t,e){this._canvas.setSize(t,e)}bind(){this._state.tool.addObserver(this,"change",(t=>{this._previousTool=this._nextPreviousTool,this._nextPreviousTool=t;for(const e of jt){const s=this._outlets[`tool-${e}`];e==t.name?s.setAttribute("data-active",""):s.removeAttribute("data-active")}this.onUpdateToolSize(),this._canvas.currentTool=t})),this._state.tool.sync(),this._canvas.observables.foreColor.addObserver(this,"change",(t=>{this._outlets.foreColor.style.backgroundColor=t.css()})),this._canvas.observables.foreColor.sync(),this._state.backgroundColor.addObserver(this,"change",(t=>{this._outlets.backgroundColor.style.backgroundColor=t.css(),this._canvas.changeBackgroundColor(t),this._canvas.requestRender()})),this._canvas.addObserver(this,"change-background-color",(t=>{this._state.backgroundColor.value=t})),this._state.backgroundColor.sync(),this._settings.observables.undoMax.addObserver(this,"change",(t=>{this._canvas.undoMax=t})),this._settings.observables.strokeMergeTime.addObserver(this,"change",(t=>{this._canvas.strokeMergeTime=t})),this._settings.addObserver(this,"change",(()=>{const t=this._settings.serialize();Wt.local.set("tegaki-settings",t)})),this._settings.sync(),this._palettePenSize.addObserver(this,"change",(t=>{this._state.tool.value.size=t,this.onUpdateToolSize()})),this._canvas.addObserver(this,"change-tool",(t=>{this._state.tool.value=t})),this._canvas.addObserver(this,"change-size",(()=>{this.resetStatus(),this.adjustWindow()})),this._canvas.addObserver(this,"update-history",(()=>{this.updateUndoRedoIcon(),this.prepareAutoSave()})),this.updateUndoRedoIcon(),document.addEventListener("visibilitychange",(()=>{this.onQuit()})),this._canvas.addObserver(this,"spoit",(t=>{console.log(),this._canvas.foreColor=t.color})),this._canvas.addObserver(this,"change-scale",(t=>{this.resetStatus(),t.scale>t.old?this.fitWindowToCanvas(!0,!1):t.scale<t.old&&this.fitWindowToCanvas(!1,!1)})),this._canvas.addObserver(this,"change-document-size",(()=>{this.resetStatus(),this.isVisible&&this.fitWindowToCanvas(!0)}))}prepareAutoSave(){0!=this._autoSaveTimer||this._autoSaveInterval<=0||(this._autoSaveTimer=window.setTimeout((async()=>{await this.autoSave(),this._autoSaveTimer=0}),60*this._autoSaveInterval*1e3))}async forceAutoSave(){0!=this._autoSaveTimer&&(await this.autoSave(),this._autoSaveTimer=0)}async autoSave(){const t=this._canvas.document.serialize();await Wt.local.set("tegaki-autosave",t),this.showStatus("",2e3)}async clearAutoSave(){window.clearTimeout(this._autoSaveTimer),this._autoSaveTimer=0,await Wt.local.remove("tegaki-autosave")}updateUndoRedoIcon(){0==this._canvas.undoLength?this._outlets["tool-undo"].setAttribute("disabled",""):this._outlets["tool-undo"].removeAttribute("disabled"),0==this._canvas.redoLength?this._outlets["tool-redo"].setAttribute("disabled",""):this._outlets["tool-redo"].removeAttribute("disabled")}onUpdateToolSize(){let t=this._state.tool.value.size;this._state.tool.value.resizeable?(this._lineSizeDisplay.value=t,this._outlets["tool-size"].removeAttribute("disabled")):(this._lineSizeDisplay.value=0,this._outlets["tool-size"].setAttribute("disabled","")),this._palettePenSize.value=t}_resetStatusTimer=0;showStatus(t,e=3e3){this._outlets.status.innerText=t,clearTimeout(this._resetStatusTimer),this._resetStatusTimer=window.setTimeout((()=>{this.resetStatus()}),e)}defaultStatusText(){return`w${this._canvas.documentWidth}:h${this._canvas.documentHeight} ${100*this._canvas.scale|0}%`}resetStatus(){clearTimeout(this._resetStatusTimer),this._outlets.status.innerText=this.defaultStatusText()}resetCanvas(){this._state.tool.value=this._toolPen,this._canvas.reset(qt.width,qt.height,qt.backgroundColor),this.onUpdateToolSize()}#St="none";async open(t,e){let s=!1;if("initializing"==this.#St)return;if("none"==this.#St){s=!0,this.#St="initializing";const t=await Wt.local.get("tegaki-autosave");if(null!=t)try{Gt(t,D.structure);const e=await D.deserialize(t);this._canvas.document=e}catch(t){console.warn(t)}}if(this.#St="initialized",this.isVisible)return;const i=this._window;var n;i.style.display="block",void 0!==t&&void 0!==e&&(i.style.left=`${t}px`,i.style.top=`${e}px`),i.focus(),s&&(n=()=>{this.fitWindowToCanvas(),void 0!==t&&void 0!==e||(t=document.documentElement.clientWidth/2-i.clientWidth/2,e=document.documentElement.clientHeight/2-i.clientHeight/2,i.style.left=`${t}px`,i.style.top=`${e}px`)},requestAnimationFrame((()=>{requestAnimationFrame(n)}))),this.adjustWindow()}close(){this._window.style.display="none"}toggle(){const t=this._window;"block"!=t.style.display?this.open():t.style.display="none"}overrideCopyButton(t,e){this._outlets["button-copy"].innerText=t,this._copyOverride=e}onQuit(){this.forceAutoSave()}onClickNew(t){this.resetCanvas()}onClickSave(t){this._canvas.download()}onClickSettings(t){const e=t.target.getBoundingClientRect();this._panelSettings.open(e.right,e.y),t.stopPropagation(),t.preventDefault()}onClickZoomIn(t){const e=this._canvas.maxScale;this._changeScale(Math.min(this._canvas.scale+.5,e))}onClickZoomOut(t){const e=this._canvas.minScale;this._changeScale(Math.max(this._canvas.scale-.5,e))}_changeScale(t){this._canvas.scale=t,this.resetStatus()}onClickOpen(t){this.toggle()}onClickClose(t){this._window.style.display="none",this._panelLayer.close()}onClickPen(t){this._state.tool.value=this._toolPen}onClickEraser(t){this._state.tool.value=this._toolEraser}onClickPenSize(t){if(!this._state.tool.value.resizeable)return;t.stopPropagation(),t.preventDefault();const e=t.target.getBoundingClientRect();this._palettePenSize.open(e.right,e.y)}onClickForeColor(t){t.stopPropagation(),t.preventDefault(),this._panelColor.close(),this._panelColor.bind(this._canvas.observables.foreColor),this._panelColor.addObserver(this,"close",(()=>{this._panelColor.removeObserver(this),this._panelColor.bind(null)}));const e=t.target.getBoundingClientRect();this._panelColor.open(e.right,e.y)}onClickBackgroundColor(t){t.stopPropagation(),t.preventDefault(),this._panelColor.close(),this._panelColor.bind(this._state.backgroundColor),this._panelColor.addObserver(this,"close",(()=>{this._panelColor.removeObserver(this),this._panelColor.bind(null)}));const e=t.target.getBoundingClientRect();this._panelColor.open(e.right,e.y)}onClickSpoit(t){this._state.tool.value=this._toolSpoit}onClickBucket(t){if(this._state.tool.value==this._toolBucket){const e=t.target.getBoundingClientRect();this._panelBucket.open(e.right,e.y),t.stopPropagation(),t.preventDefault()}else this._state.tool.value=this._toolBucket}onClickSelect(t){this._state.tool.value==this._toolSelect?this._canvas.selectNew(null):this._state.tool.value=this._toolSelect}onClickClear(t){this._canvas.clear()}onClickFill(t){this._canvas.fill(this._canvas.foreColor)}onClickFlip(t){this._canvas.flip()}async onClickCopy(t){this._copyOverride?this._copyOverride():(await this._canvas.copyToClipboard(),this.showStatus(""))}onClickUndo(t){this._canvas.undo()}onClickRedo(t){this._canvas.redo()}onClickLayer(t){const e=this._window.getBoundingClientRect();this._panelLayer.toggle(e.right+1,e.top)}onClickResize(t){const e=t.target.getBoundingClientRect();this._panelResize.toggle(e.right,e.y)}onBlur(t){for(const[t,e]of this._shortcutDownTime)this.endShortcut(t,e);this._shortcutDownTime.clear()}onKeydown(t){t.stopPropagation(),this.findAndExecuteShortcut(t)&&t.preventDefault()}onKeyPress(t){t.stopPropagation(),Qt.match(t)&&t.preventDefault()}onWheelOnCanvas(t){t.stopPropagation(),this.findAndExecuteShortcut({key:t.deltaY<0?"WheelUp":"WheelDown",ctrlKey:t.ctrlKey,altKey:t.altKey,shiftKey:t.shiftKey,repeat:!1})&&t.preventDefault()}findAndExecuteShortcut(t){const e=Qt.match(t);if(null==e)return!1;const s=Date.now();return!1!==this.onShortcut(e)&&(this._shortcutDownTime.set(e,s),!0)}onShortcut(t){switch(t.name){case"undo":this._canvas.undo();break;case"redo":this._canvas.redo();break;case"copy":this.onClickCopy();break;case"select-all":this._canvas.selectAll();break;case"deselect":this._canvas.selectNew(null);break;case"clear":null!==this._canvas.selectedRegion&&this._canvas.clear();break;case"pencil":if(this._state.tool.value==this._toolPen)return!1;this._state.tool.value=this._toolPen;break;case"eraser":if(this._state.tool.value==this._toolEraser)return!1;this._state.tool.value=this._toolEraser;break;case"spoit":if(this._state.tool.value==this._toolSpoit)return!1;this._state.tool.value=this._toolSpoit;break;case"bucket":if(this._state.tool.value==this._toolBucket)return!1;this._state.tool.value=this._toolBucket;break;case"select":if(this._state.tool.value==this._toolSelect)return!1;this._state.tool.value=this._toolSelect;break;case"scroll":if(this._state.tool.value==this._toolScroll)return!1;this._state.tool.value=this._toolScroll;break;case"move-up":this._canvas.selectMove(0,-1);break;case"move-down":this._canvas.selectMove(0,1);break;case"move-left":this._canvas.selectMove(-1,0);break;case"move-right":this._canvas.selectMove(1,0);break;case"move-fast-up":this._canvas.selectMove(0,-10);break;case"move-fast-down":this._canvas.selectMove(0,10);break;case"move-fast-left":this._canvas.selectMove(-10,0);break;case"move-fast-right":this._canvas.selectMove(10,0);break;case"grab-up":this._canvas.selectGrabMove(0,-1);break;case"grab-down":this._canvas.selectGrabMove(0,1);break;case"grab-left":this._canvas.selectGrabMove(-1,0);break;case"grab-right":this._canvas.selectGrabMove(1,0);break;case"zoom-in":this._canvas.zoomAtPointer(1.1,!0);break;case"zoom-out":this._canvas.zoomAtPointer(.9,!0);break;case"pensize-down":this.increasePensize(-1);break;case"pensize-up":this.increasePensize(1)}}increasePensize(t){this._state.tool.value.resizeable&&(this._state.tool.value.size+=t,this.onUpdateToolSize())}onKeyup(t){this._onKeyUp(t.key)}_onKeyUp(t){for(let[e,s]of this._shortcutDownTime){if(e.key!=t)return;this.endShortcut(e,s),this._shortcutDownTime.delete(e)}}endShortcut(t,e){const s=Date.now();("Temporary"==t.mode||"PressTemp"==t.mode&&s-e>300)&&(this._state.tool.value=this._previousTool)}fitWindowToCanvas(t=!0,e=!0){if(!this.isVisible)return;const s=this._window,n=s.getBoundingClientRect(),r=document.documentElement.clientWidth,o=document.documentElement.clientHeight;let a=i(this._canvas.documentWidth*this._canvas.scale+s.clientWidth-this._canvas.width+1,Kt,r),h=i(this._canvas.documentHeight*this._canvas.scale+s.clientHeight-this._canvas.height+1,Zt,o);e||(a=Math.max(a,n.width),h=Math.max(h,n.height)),t||(a=Math.min(a,n.width),h=Math.min(h,n.height)),this.setWindowSize(Math.ceil(a),Math.ceil(h))}adjustWindow(){const t=this._window,e=t.getBoundingClientRect();e.x<0?t.style.left="0":e.right>document.documentElement.clientWidth&&(t.style.left=document.documentElement.clientWidth-e.width+"px"),e.y<0?t.style.top="0":e.bottom>document.documentElement.clientHeight&&(t.style.top=document.documentElement.clientHeight-e.height+"px")}disableClose(){this._outlets["button-close"].style.display="none"}static async launch(){const t=await Ht.load("tegaki-settings");return new te(t)}}window.DiscoTegaki=te})();